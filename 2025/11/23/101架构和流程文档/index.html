

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="無鎏雲">
  <meta name="keywords" content="">
  
    <meta name="description" content="Kcat短剧平台 - 系统架构与业务流程完整文档 目录 系统概述 整体技术架构 服务模块详解 核心业务流程 服务间交互关系 数据库设计 技术亮点与最佳实践 部署架构   一、系统概述1.1 项目背景Kcat短剧平台是一个基于微服务架构的短视频内容分发平台，专注于短剧内容的创作、审核、发布、播放与用户互动。系统采用RuoYi-Cloud脚手架构建，集成了工作流引擎、AI审核、视频处理、消息队列等现代">
<meta property="og:type" content="article">
<meta property="og:title" content="100快猫短剧">
<meta property="og:url" content="http://example.com/2025/11/23/101%E6%9E%B6%E6%9E%84%E5%92%8C%E6%B5%81%E7%A8%8B%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="NoFlowCloud">
<meta property="og:description" content="Kcat短剧平台 - 系统架构与业务流程完整文档 目录 系统概述 整体技术架构 服务模块详解 核心业务流程 服务间交互关系 数据库设计 技术亮点与最佳实践 部署架构   一、系统概述1.1 项目背景Kcat短剧平台是一个基于微服务架构的短视频内容分发平台，专注于短剧内容的创作、审核、发布、播放与用户互动。系统采用RuoYi-Cloud脚手架构建，集成了工作流引擎、AI审核、视频处理、消息队列等现代">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-11-23T04:07:57.000Z">
<meta property="article:modified_time" content="2025-11-25T06:55:16.431Z">
<meta property="article:author" content="無鎏雲">
<meta property="article:tag" content="kcat">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>100快猫短剧 - NoFlowCloud</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Noflowcloud-Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="100快猫短剧"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-23 12:07" pubdate>
          2025年11月23日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          110 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">100快猫短剧</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Kcat短剧平台-系统架构与业务流程完整文档"><a href="#Kcat短剧平台-系统架构与业务流程完整文档" class="headerlink" title="Kcat短剧平台 - 系统架构与业务流程完整文档"></a>Kcat短剧平台 - 系统架构与业务流程完整文档</h1><hr>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#%E4%B8%80%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0">系统概述</a></li>
<li><a href="#%E4%BA%8C%E6%95%B4%E4%BD%93%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84">整体技术架构</a></li>
<li><a href="#%E4%B8%89%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E8%AF%A6%E8%A7%A3">服务模块详解</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B">核心业务流程</a></li>
<li><a href="#%E4%BA%94%E6%9C%8D%E5%8A%A1%E9%97%B4%E4%BA%A4%E4%BA%92%E5%85%B3%E7%B3%BB">服务间交互关系</a></li>
<li><a href="#%E5%85%AD%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1">数据库设计</a></li>
<li><a href="#%E4%B8%83%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">技术亮点与最佳实践</a></li>
<li><a href="#%E5%85%AB%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84">部署架构</a></li>
</ol>
<hr>
<h2 id="一、系统概述"><a href="#一、系统概述" class="headerlink" title="一、系统概述"></a>一、系统概述</h2><h3 id="1-1-项目背景"><a href="#1-1-项目背景" class="headerlink" title="1.1 项目背景"></a>1.1 项目背景</h3><p><strong>Kcat短剧平台</strong>是一个基于微服务架构的短视频内容分发平台，专注于短剧内容的创作、审核、发布、播放与用户互动。系统采用RuoYi-Cloud脚手架构建，集成了工作流引擎、AI审核、视频处理、消息队列等现代化技术栈。</p>
<h3 id="1-2-核心功能"><a href="#1-2-核心功能" class="headerlink" title="1.2 核心功能"></a>1.2 核心功能</h3><ul>
<li><strong>内容管理</strong>: 短剧、剧集、演员、分类、标签的全生命周期管理</li>
<li><strong>智能审核</strong>: AI自动审核 + 人工复核的混合审核机制</li>
<li><strong>视频处理</strong>: 腾讯云VOD转码（多清晰度+信息流格式）</li>
<li><strong>用户系统</strong>: 手机验证码登录、JWT认证、用户画像</li>
<li><strong>社交互动</strong>: 点赞、评论、弹幕、分享、收藏、关注</li>
<li><strong>推荐分发</strong>: 首页精选视频流、个性化推荐（待完善）</li>
</ul>
<h3 id="1-3-技术特色"><a href="#1-3-技术特色" class="headerlink" title="1.3 技术特色"></a>1.3 技术特色</h3><ol>
<li><strong>微服务架构</strong>: Spring Cloud + Nacos实现服务治理</li>
<li><strong>工作流引擎</strong>: Camunda BPM可视化编排复杂业务流程</li>
<li><strong>AI能力集成</strong>: Ollama本地模型 + DeepSeek云端模型</li>
<li><strong>事件驱动</strong>: Kafka异步解耦，实现最终一致性</li>
<li><strong>分布式缓存</strong>: Redis三高防护（穿透&#x2F;击穿&#x2F;雪崩）</li>
<li><strong>视频云处理</strong>: 腾讯云VOD专业转码服务</li>
</ol>
<hr>
<h2 id="二、整体技术架构"><a href="#二、整体技术架构" class="headerlink" title="二、整体技术架构"></a>二、整体技术架构</h2><h3 id="2-1-架构图"><a href="#2-1-架构图" class="headerlink" title="2.1 架构图"></a>2.1 架构图</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs nix">┌─────────────────────────────────────────────────────────────────────┐<br>│                           移动端 <span class="hljs-symbol">/</span> Web前端                            │<br>│                      (iOS <span class="hljs-symbol">/</span> Android <span class="hljs-symbol">/</span> H5)                            │<br>└──────────────────────────────┬──────────────────────────────────────┘<br>                               │ HTTPS<br>                               ▼<br>┌─────────────────────────────────────────────────────────────────────┐<br>│                        API网关 (Gateway)                             │<br>│                   路由转发 <span class="hljs-symbol">/</span> 鉴权 <span class="hljs-symbol">/</span> 限流 <span class="hljs-symbol">/</span> 日志                        │<br>└──────────┬──────────────────┬──────────────────┬────────────────────┘<br>           │                  │                  │<br>           ▼                  ▼                  ▼<br>┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐<br>│  user-service    │  │ content-service  │  │interaction-service│<br>│  (用户服务)       │  │  (内容服务)      │  │  (互动服务)       │<br>│  端口: <span class="hljs-number">10003</span>     │  │  端口: <span class="hljs-number">10001</span>     │  │  端口: <span class="hljs-number">10004</span>      │<br>│                  │  │                  │  │                   │<br>│ <span class="hljs-operator">-</span> 用户认证登录    │  │ <span class="hljs-operator">-</span> 短剧管理       │  │ <span class="hljs-operator">-</span> 点赞<span class="hljs-operator">/</span>评论       │<br>│ <span class="hljs-operator">-</span> BFF聚合层      │  │ <span class="hljs-operator">-</span> 剧集管理       │  │ <span class="hljs-operator">-</span> 弹幕<span class="hljs-operator">/</span>分享       │<br>│ <span class="hljs-operator">-</span> 首页数据       │  │ <span class="hljs-operator">-</span> 短剧发布       │  │ <span class="hljs-operator">-</span> 举报审核        │<br>│ <span class="hljs-operator">-</span> 点赞事件生产    │  │ <span class="hljs-operator">-</span> 文件上传       │  │ <span class="hljs-operator">-</span> 内容统计        │<br>└────────┬─────────┘  └─────────┬────────┘  └────────┬─────────┘<br>         │                      │                     │<br>         │                      │                     │<br>         ├──────────────────────┴─────────────────────┤<br>         │              Feign远程调用                  │<br>         │                      │                     │<br>         │                      ▼                     │<br>         │            ┌──────────────────┐            │<br>         │            │ camunda-service  │            │<br>         │            │  (工作流服务)     │            │<br>         │            │  端口: <span class="hljs-number">10002</span>     │            │<br>         │            │                  │            │<br>         │            │ <span class="hljs-operator">-</span> 审核流程编排    │            │<br>         │            │ <span class="hljs-operator">-</span> AI内容审核     │            │<br>         │            │ <span class="hljs-operator">-</span> 转码任务触发    │            │<br>         │            └────────┬─────────┘            │<br>         │                     │                      │<br>         └─────────────────────┴──────────────────────┘<br>                               │<br>         ┌─────────────────────┼──────────────────────┐<br>         │                     │                      │<br>         ▼                     ▼                      ▼<br>┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐<br>│  Kafka集群       │  │  Redis集群       │  │  MySQL数据库     │<br>│                  │  │                  │  │                  │<br>│ <span class="hljs-operator">-</span> 点赞事件       │  │ <span class="hljs-operator">-</span> 缓存热点数据   │  │ <span class="hljs-operator">-</span> 用户数据       │<br>│ <span class="hljs-operator">-</span> 评论事件       │  │ <span class="hljs-operator">-</span> 验证码存储     │  │ <span class="hljs-operator">-</span> 内容数据       │<br>│ <span class="hljs-operator">-</span> 消息队列       │  │ <span class="hljs-operator">-</span> 点赞状态       │  │ <span class="hljs-operator">-</span> 互动数据       │<br>│                  │  │ <span class="hljs-operator">-</span> 布隆过滤器     │  │ <span class="hljs-operator">-</span> 审核流程       │<br>└──────────────────┘  └──────────────────┘  └──────────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│                          基础设施层                                   │<br>├──────────────────┬──────────────────┬──────────────────┬────────────┤<br>│  Nacos           │  Sentinel        │  XXL-Job         │  ELK       │<br>│  (注册<span class="hljs-operator">+</span>配置中心)  │  (限流<span class="hljs-operator">+</span>熔断)      │  (任务调度)       │  (日志)    │<br>└──────────────────┴──────────────────┴──────────────────┴────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│                          外部服务                                     │<br>├──────────────────┬──────────────────┬──────────────────┬────────────┤<br>│  腾讯云VOD       │  MinIO对象存储   │  Ollama AI       │  阿里云短信 │<br>│  (视频转码)      │  (文件存储)      │  (本地AI模型)     │  (验证码)  │<br>└──────────────────┴──────────────────┴──────────────────┴────────────┘<br></code></pre></td></tr></table></figure>

<h3 id="2-2-技术栈总览"><a href="#2-2-技术栈总览" class="headerlink" title="2.2 技术栈总览"></a>2.2 技术栈总览</h3><table>
<thead>
<tr>
<th>技术分层</th>
<th>技术选型</th>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>基础框架</strong></td>
<td>Spring Boot</td>
<td>3.4.x</td>
<td>核心应用框架</td>
</tr>
<tr>
<td></td>
<td>Spring Cloud</td>
<td>2024.0.0</td>
<td>微服务生态</td>
</tr>
<tr>
<td></td>
<td>Java</td>
<td>17</td>
<td>开发语言</td>
</tr>
<tr>
<td><strong>服务治理</strong></td>
<td>Nacos</td>
<td>最新</td>
<td>服务注册发现+配置中心</td>
</tr>
<tr>
<td></td>
<td>Sentinel</td>
<td>最新</td>
<td>流量控制+熔断降级</td>
</tr>
<tr>
<td></td>
<td>OpenFeign</td>
<td>最新</td>
<td>声明式HTTP客户端</td>
</tr>
<tr>
<td></td>
<td>LoadBalancer</td>
<td>最新</td>
<td>客户端负载均衡</td>
</tr>
<tr>
<td><strong>数据存储</strong></td>
<td>MySQL</td>
<td>8.0+</td>
<td>关系型数据库</td>
</tr>
<tr>
<td></td>
<td>MyBatis-Plus</td>
<td>3.5.12</td>
<td>ORM增强框架</td>
</tr>
<tr>
<td></td>
<td>Redis</td>
<td>最新</td>
<td>缓存+分布式锁</td>
</tr>
<tr>
<td></td>
<td>Redisson</td>
<td>3.50.0</td>
<td>分布式工具包</td>
</tr>
<tr>
<td><strong>消息队列</strong></td>
<td>Kafka</td>
<td>最新</td>
<td>事件驱动消息中间件</td>
</tr>
<tr>
<td><strong>工作流</strong></td>
<td>Camunda BPM</td>
<td>7.23.0</td>
<td>BPMN工作流引擎</td>
</tr>
<tr>
<td><strong>认证授权</strong></td>
<td>Sa-Token</td>
<td>1.44.0</td>
<td>轻量级权限框架</td>
</tr>
<tr>
<td><strong>AI能力</strong></td>
<td>Spring AI</td>
<td>1.0.1</td>
<td>AI统一接口</td>
</tr>
<tr>
<td></td>
<td>Ollama</td>
<td>最新</td>
<td>本地AI模型服务</td>
</tr>
<tr>
<td></td>
<td>DeepSeek</td>
<td>最新</td>
<td>云端AI模型</td>
</tr>
<tr>
<td><strong>文件存储</strong></td>
<td>MinIO</td>
<td>8.5.13</td>
<td>对象存储服务</td>
</tr>
<tr>
<td></td>
<td>腾讯云VOD</td>
<td>2.1.5</td>
<td>视频点播服务</td>
</tr>
<tr>
<td><strong>任务调度</strong></td>
<td>XXL-Job</td>
<td>3.2.0</td>
<td>分布式任务调度</td>
</tr>
<tr>
<td><strong>工具库</strong></td>
<td>Lombok</td>
<td>1.18.20</td>
<td>简化Java代码</td>
</tr>
<tr>
<td></td>
<td>Hutool</td>
<td>5.8.39</td>
<td>Java工具集</td>
</tr>
<tr>
<td><strong>监控日志</strong></td>
<td>Logback</td>
<td>最新</td>
<td>日志框架</td>
</tr>
<tr>
<td></td>
<td>Knife4j</td>
<td>最新</td>
<td>接口文档</td>
</tr>
</tbody></table>
<h3 id="2-3-网络拓扑"><a href="#2-3-网络拓扑" class="headerlink" title="2.3 网络拓扑"></a>2.3 网络拓扑</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scss">VPC网络 (<span class="hljs-number">172.16</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span>)<br>│<br>├── 应用子网 (<span class="hljs-number">172.16</span>.<span class="hljs-number">1.0</span>/<span class="hljs-number">24</span>)<br>│   ├── user-service (<span class="hljs-number">10003</span>)<br>│   ├── <span class="hljs-attribute">content</span>-service (<span class="hljs-number">10001</span>)<br>│   ├── interaction-service (<span class="hljs-number">10004</span>)<br>│   └── camunda-service (<span class="hljs-number">10002</span>)<br>│<br>├── 中间件子网 (<span class="hljs-number">172.16</span>.<span class="hljs-number">2.0</span>/<span class="hljs-number">24</span>)<br>│   ├── MySQL (<span class="hljs-number">3306</span>)<br>│   ├── Redis (<span class="hljs-number">6379</span>)<br>│   ├── Kafka (<span class="hljs-number">9092</span>)<br>│   └── Nacos (<span class="hljs-number">8848</span>)<br>│<br>└── 外部服务<br>    ├── 腾讯云VOD API<br>    ├── MinIO (<span class="hljs-number">9000</span>)<br>    ├── Ollama (<span class="hljs-number">11434</span>)<br>    └── 阿里云短信API<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="三、服务模块详解"><a href="#三、服务模块详解" class="headerlink" title="三、服务模块详解"></a>三、服务模块详解</h2><h3 id="3-1-user-service（用户服务-BFF层）"><a href="#3-1-user-service（用户服务-BFF层）" class="headerlink" title="3.1 user-service（用户服务&#x2F;BFF层）"></a>3.1 user-service（用户服务&#x2F;BFF层）</h3><h4 id="3-1-1-服务定位"><a href="#3-1-1-服务定位" class="headerlink" title="3.1.1 服务定位"></a>3.1.1 服务定位</h4><p><strong>角色</strong>: Backend For Frontend（前端后端聚合层）</p>
<p><strong>核心职责</strong>:</p>
<ol>
<li>用户认证与授权（短信验证码登录、JWT令牌管理）</li>
<li>聚合内容服务和互动服务的数据</li>
<li>提供统一的App端API接口</li>
<li>分布式缓存代理（三高防护）</li>
<li>Kafka事件生产（点赞事件）</li>
</ol>
<h4 id="3-1-2-技术架构"><a href="#3-1-2-技术架构" class="headerlink" title="3.1.2 技术架构"></a>3.1.2 技术架构</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs scss">Controller层<br>  ├── LoginController (认证相关)<br>  ├── VerifyCodeController (验证码)<br>  ├── AppHomeController (首页数据)<br>  └── AppInteractionController (互动功能)<br>       ↓<br>BizService层（业务编排）<br>  ├── UserAuthServiceImpl (用户认证业务)<br>  ├── DramaBizServiceImpl (短剧业务+缓存)<br>  ├── LikeBizServiceImpl (点赞业务+Kafka生产)<br>  ├── CommentBizServiceImpl (评论业务)<br>  └── VerifyCodeServiceImpl (验证码业务)<br>       ↓<br>Feign客户端（服务调用）<br>  ├── ContentFeignClient → <span class="hljs-attribute">content</span>-service<br>  └── InteractionFeignClient → interaction-service<br>       ↓<br>Service层（数据访问）<br>  ├── UsersService<br>  ├── UserAuthsService<br>  ├── UserFollowsService<br>  └── ... (<span class="hljs-number">9</span>个Service)<br>       ↓<br>Mapper层（MyBatis-Plus）<br>  └── <span class="hljs-number">9</span>个Mapper接口 + XML<br></code></pre></td></tr></table></figure>

<h4 id="3-1-3-核心功能模块"><a href="#3-1-3-核心功能模块" class="headerlink" title="3.1.3 核心功能模块"></a>3.1.3 核心功能模块</h4><p><strong>1. 用户认证模块</strong></p>
<ul>
<li><strong>短信验证码登录</strong>:<ul>
<li>发送6位数字验证码（Redis存储5分钟）</li>
<li>验证通过自动注册（生成”游客+随机6位数”昵称）</li>
<li>Sa-Token登录并生成JWT令牌</li>
</ul>
</li>
<li><strong>用户信息查询</strong>:<ul>
<li>CompletableFuture并发查询5个维度数据</li>
<li>自定义线程池优化性能</li>
</ul>
</li>
</ul>
<p><strong>2. 首页数据聚合模块</strong></p>
<ul>
<li><strong>首页精选视频</strong>:<ul>
<li>远程调用content-service获取短剧列表</li>
<li>Redis手动缓存（key包含分页参数）</li>
<li>查询用户点赞状态（Redis Set）</li>
</ul>
</li>
<li><strong>短剧详情</strong>:<ul>
<li>使用@CacheData注解AOP缓存</li>
<li>布隆过滤器防止缓存穿透</li>
<li>Redisson分布式锁防止缓存击穿</li>
<li>随机过期时间防止缓存雪崩</li>
</ul>
</li>
</ul>
<p><strong>3. 互动功能模块</strong></p>
<ul>
<li><strong>点赞功能</strong>:<ul>
<li>登录校验</li>
<li>构造LikeEvent事件</li>
<li>发送到Kafka（Topic: like-event-topic）</li>
<li>生产者拦截器自动填充msgId、userId、timestamp</li>
</ul>
</li>
<li><strong>评论查询</strong>:<ul>
<li>远程调用interaction-service</li>
</ul>
</li>
</ul>
<h4 id="3-1-4-数据模型（9张表）"><a href="#3-1-4-数据模型（9张表）" class="headerlink" title="3.1.4 数据模型（9张表）"></a>3.1.4 数据模型（9张表）</h4><table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
<th>核心字段</th>
</tr>
</thead>
<tbody><tr>
<td>users</td>
<td>用户基本信息</td>
<td>userId, phone, nickname, avatar, gender, level, experience</td>
</tr>
<tr>
<td>user_auths</td>
<td>用户认证方式</td>
<td>authId, userId, authType(password&#x2F;sms&#x2F;wechat&#x2F;qq&#x2F;apple), authKey, authCredential</td>
</tr>
<tr>
<td>user_follows</td>
<td>用户关注关系</td>
<td>followId, followerId, followeeId, status</td>
</tr>
<tr>
<td>user_collections</td>
<td>用户收藏</td>
<td>collectionId, userId, dramaId, dramaTitle, dramaCover</td>
</tr>
<tr>
<td>user_browse_history</td>
<td>浏览历史</td>
<td>historyId, userId, dramaId, title, cover, browseTime, browseDuration</td>
</tr>
<tr>
<td>user_devices</td>
<td>用户设备</td>
<td>deviceId, userId, deviceType, deviceToken(推送)</td>
</tr>
<tr>
<td>user_blacklist</td>
<td>用户黑名单</td>
<td>blacklistId, userId, blockedUserId</td>
</tr>
<tr>
<td>user_level_config</td>
<td>用户等级配置</td>
<td>levelId, levelName, minExperience, maxExperience, benefits</td>
</tr>
<tr>
<td>user_preferences</td>
<td>用户偏好设置</td>
<td>preferenceId, userId, autoPlay, pushNotification, privacySettings</td>
</tr>
</tbody></table>
<h4 id="3-1-5-API接口清单"><a href="#3-1-5-API接口清单" class="headerlink" title="3.1.5 API接口清单"></a>3.1.5 API接口清单</h4><table>
<thead>
<tr>
<th>接口路径</th>
<th>方法</th>
<th>功能</th>
<th>权限</th>
</tr>
</thead>
<tbody><tr>
<td><code>/api/login</code></td>
<td>POST</td>
<td>手机验证码登录</td>
<td>公开</td>
</tr>
<tr>
<td><code>/api/userinfo</code></td>
<td>GET</td>
<td>获取当前用户信息</td>
<td>需登录</td>
</tr>
<tr>
<td><code>/api/send-code</code></td>
<td>POST</td>
<td>发送验证码</td>
<td>公开</td>
</tr>
<tr>
<td><code>/api/episodes/featured</code></td>
<td>GET</td>
<td>首页精选视频流</td>
<td>公开</td>
</tr>
<tr>
<td><code>/api/dramas/&#123;dramaId&#125;</code></td>
<td>GET</td>
<td>短剧详情</td>
<td>公开</td>
</tr>
<tr>
<td><code>/api/dramas/&#123;dramaId&#125;/episodes/all</code></td>
<td>GET</td>
<td>短剧剧集列表</td>
<td>公开</td>
</tr>
<tr>
<td><code>/api/episodes/&#123;episodeId&#125;/like</code></td>
<td>POST</td>
<td>点赞&#x2F;取消点赞</td>
<td>需登录</td>
</tr>
<tr>
<td><code>/api/episodes/&#123;episodeId&#125;/comments</code></td>
<td>GET</td>
<td>获取评论列表</td>
<td>公开</td>
</tr>
</tbody></table>
<hr>
<h3 id="3-2-content-service（内容服务）"><a href="#3-2-content-service（内容服务）" class="headerlink" title="3.2 content-service（内容服务）"></a>3.2 content-service（内容服务）</h3><h4 id="3-2-1-服务定位"><a href="#3-2-1-服务定位" class="headerlink" title="3.2.1 服务定位"></a>3.2.1 服务定位</h4><p><strong>角色</strong>: 核心内容管理服务</p>
<p><strong>核心职责</strong>:</p>
<ol>
<li>短剧、剧集、演员、分类、标签的CRUD</li>
<li>短剧发布流程（多表事务操作）</li>
<li>文件上传（MinIO对象存储）</li>
<li>视频转码（腾讯云VOD）</li>
<li>审核流程集成（调用camunda-service）</li>
<li>提供RPC接口给user-service</li>
</ol>
<h4 id="3-2-2-技术架构"><a href="#3-2-2-技术架构" class="headerlink" title="3.2.2 技术架构"></a>3.2.2 技术架构</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Controller层<br>  ├── DramasController (短剧管理)<br>  ├── EpisodesController (剧集管理)<br>  ├── ActorsController (演员管理)<br>  ├── CategoriesController (分类管理)<br>  ├── TagsController (标签管理)<br>  ├── PublishController (短剧发布)<br>  ├── AuthCheckController (审核检查)<br>  ├── UploadController (文件上传)<br>  └── rpc/<br>      ├── AppHomeDataController (首页数据RPC)<br>      └── TencentVodController (视频转码RPC)<br>       ↓<br>BizService层<br>  ├── DramaPublishServiceImpl (发布业务)<br>  ├── AuthCheckServiceImpl (审核业务)<br>  ├── DramaHomeServiceImpl (首页业务)<br>  └── TencentVodServiceImpl (转码业务)<br>       ↓<br>Feign客户端<br>  └── CamundaFeignClient → camunda<span class="hljs-params">-service</span><br>       ↓<br>Service层（<span class="hljs-number">10</span>个Service）<br>  ├── DramasService<br>  ├── EpisodesService<br>  ├── ActorsService<br>  └── <span class="hljs-params">...</span> (其他Service)<br>       ↓<br>Mapper层<br>  └── <span class="hljs-number">10</span>个Mapper + <span class="hljs-built_in">XML</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-3-核心功能模块"><a href="#3-2-3-核心功能模块" class="headerlink" title="3.2.3 核心功能模块"></a>3.2.3 核心功能模块</h4><p><strong>1. 短剧发布流程（事务性操作）</strong></p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-number">1</span>. 保存短剧基本信息 → dramas表<br><span class="hljs-number">2</span>. 保存短剧与分类关联 → dram<span class="hljs-built_in">a_categories</span>表<br><span class="hljs-number">3</span>. 保存短剧与标签关联 → dram<span class="hljs-built_in">a_tags</span>表<br><span class="hljs-number">4</span>. 保存短剧与演员关联 → dram<span class="hljs-built_in">a_actors</span>表<br>   - 新演员：先插入actors表，再插入关联表<br>   - 已有演员：直接插入关联表<br><span class="hljs-number">5</span>. 保存剧集信息 → episodes表<br><span class="hljs-number">6</span>. 启动Camunda审核流程 → 调用camunda-service<br><span class="hljs-number">7</span>. 保存审核流程关系 → dram<span class="hljs-built_in">a_auth</span>表<br></code></pre></td></tr></table></figure>

<p><strong>2. 文件上传模块</strong></p>
<ul>
<li>使用MinIO对象存储</li>
<li>Bucket: “kcat”</li>
<li>支持图片、视频上传</li>
<li>返回访问URL</li>
</ul>
<p><strong>3. 视频转码模块</strong></p>
<ul>
<li><strong>信息流转码</strong>（竖屏短视频格式）:<ul>
<li>处理预告片或第一集</li>
<li>保存到dramas.trailerInfoflowUrl</li>
</ul>
</li>
<li><strong>画质转码</strong>（多清晰度）:<ul>
<li>1080p (高清) → episodes.videoUrlHd</li>
<li>720p (标清) → episodes.videoUrlSd</li>
<li>480p (低清) → episodes.videoUrlLd</li>
</ul>
</li>
<li><strong>转码流程</strong>:<ol>
<li>从MinIO下载视频到临时文件</li>
<li>上传到腾讯云VOD</li>
<li>指定转码模板</li>
<li>轮询PullEvents获取转码结果</li>
<li>ConfirmEvents确认事件</li>
<li>更新数据库URL</li>
</ol>
</li>
</ul>
<p><strong>4. 审核状态管理</strong></p>
<ul>
<li>AI审核状态查询</li>
<li>更新审核状态（审核完成后回调）</li>
<li>将通过审核的dramaId添加到布隆过滤器</li>
</ul>
<p><strong>5. 首页数据接口（RPC）</strong></p>
<ul>
<li><strong>查询首页精选视频</strong>:<ul>
<li>分页查询已上架且审核通过的短剧</li>
<li>返回信息流剧集</li>
<li>包含短剧详情、演员、标签、分类</li>
</ul>
</li>
<li><strong>查询短剧所有剧集</strong>:<ul>
<li>短剧基本信息</li>
<li>所有剧集列表（按集数排序）</li>
<li>统计信息（总集数、可观看数等）</li>
</ul>
</li>
<li><strong>查询短剧详情</strong>:<ul>
<li>封面、标题、描述</li>
<li>播放量、点赞数</li>
<li>演员信息</li>
</ul>
</li>
</ul>
<p><strong>6. 布隆过滤器维护</strong></p>
<ul>
<li>应用启动时初始化</li>
<li>定时任务：每晚3点增量添加短剧ID</li>
<li>每周重建布隆过滤器</li>
</ul>
<h4 id="3-2-4-数据模型（10张表）"><a href="#3-2-4-数据模型（10张表）" class="headerlink" title="3.2.4 数据模型（10张表）"></a>3.2.4 数据模型（10张表）</h4><table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
<th>核心字段</th>
</tr>
</thead>
<tbody><tr>
<td>dramas</td>
<td>短剧表</td>
<td>dramaId, title, cover, poster, trailerUrl, description, totalEpisodes, status, auditStatus</td>
</tr>
<tr>
<td>episodes</td>
<td>剧集表</td>
<td>episodeId, dramaId, title, episodeNumber, videoUrl(多清晰度), duration, isFree, coinPrice</td>
</tr>
<tr>
<td>actors</td>
<td>演员表</td>
<td>actorId, actorName, actorImg, actorInfo, birthday, nationality</td>
</tr>
<tr>
<td>categories</td>
<td>分类表</td>
<td>categoryId, categoryName, parentId, sort</td>
</tr>
<tr>
<td>tags</td>
<td>标签表</td>
<td>tagId, tagName, hotCount</td>
</tr>
<tr>
<td>content_audits</td>
<td>内容审核记录表</td>
<td>auditId, contentId, contentType, auditStatus, auditReason, auditor</td>
</tr>
<tr>
<td>drama_auth</td>
<td>短剧审核流程表</td>
<td>dramaId, processId(Camunda流程ID), stepName, authStatus</td>
</tr>
<tr>
<td>drama_actors</td>
<td>短剧演员关联表</td>
<td>dramaId, actorId, roleName, roleType(主角&#x2F;配角&#x2F;客串), sortOrder</td>
</tr>
<tr>
<td>drama_categories</td>
<td>短剧分类关联表</td>
<td>dramaId, categoryId</td>
</tr>
<tr>
<td>drama_tags</td>
<td>短剧标签关联表</td>
<td>dramaId, tagId</td>
</tr>
</tbody></table>
<h4 id="3-2-5-外部依赖"><a href="#3-2-5-外部依赖" class="headerlink" title="3.2.5 外部依赖"></a>3.2.5 外部依赖</h4><table>
<thead>
<tr>
<th>服务</th>
<th>用途</th>
<th>调用方式</th>
</tr>
</thead>
<tbody><tr>
<td>camunda-service</td>
<td>启动审核流程</td>
<td>Feign</td>
</tr>
<tr>
<td>MinIO</td>
<td>文件存储</td>
<td>MinioTemplate</td>
</tr>
<tr>
<td>腾讯云VOD</td>
<td>视频转码</td>
<td>VOD SDK</td>
</tr>
<tr>
<td>XXL-Job</td>
<td>定时任务（布隆过滤器重建、转码任务）</td>
<td>HTTP调用</td>
</tr>
<tr>
<td>Redis&#x2F;Redisson</td>
<td>布隆过滤器、缓存</td>
<td>Redisson客户端</td>
</tr>
</tbody></table>
<hr>
<h3 id="3-3-interaction-service（互动服务）"><a href="#3-3-interaction-service（互动服务）" class="headerlink" title="3.3 interaction-service（互动服务）"></a>3.3 interaction-service（互动服务）</h3><h4 id="3-3-1-服务定位"><a href="#3-3-1-服务定位" class="headerlink" title="3.3.1 服务定位"></a>3.3.1 服务定位</h4><p><strong>角色</strong>: 用户互动数据服务</p>
<p><strong>核心职责</strong>:</p>
<ol>
<li>点赞、评论、弹幕、分享、举报等互动功能</li>
<li>Kafka消费点赞事件（最终一致性）</li>
<li>更新Redis缓存中的点赞数</li>
<li>内容统计数据管理</li>
<li>提供RPC接口给user-service</li>
</ol>
<h4 id="3-3-2-技术架构"><a href="#3-3-2-技术架构" class="headerlink" title="3.3.2 技术架构"></a>3.3.2 技术架构</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Controller层<br>  └── rpc/<br>      ├── LikeActionController (点赞接口)<br>      └── CommentsController (评论接口)<br>       ↓<br>BizService层<br>  ├── LikeBizServiceImpl (点赞业务)<br>  └── CommentBizServiceImpl (评论业务)<br>       ↓<br>Kafka监听器<br>  └── LikeEventListener (点赞事件消费)<br>       ↓<br>Service层（<span class="hljs-number">9</span>个Service）<br>  ├── UserLikesService<br>  ├── CommentsService<br>  ├── ContentStatisticsService<br>  ├── DanmakuService<br>  └── <span class="hljs-params">...</span> (其他Service)<br>       ↓<br>Mapper层<br>  └── <span class="hljs-number">9</span>个Mapper + <span class="hljs-built_in">XML</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-核心功能模块"><a href="#3-3-3-核心功能模块" class="headerlink" title="3.3.3 核心功能模块"></a>3.3.3 核心功能模块</h4><p><strong>1. 点赞功能（Kafka异步消费）</strong></p>
<ul>
<li><strong>Kafka监听器</strong>:<ul>
<li>Topic: <code>like-event-topic</code></li>
<li>消费LikeEvent事件</li>
<li>更新数据库点赞记录（幂等操作）</li>
<li>更新Redis缓存中的点赞数（首页精选视频缓存）</li>
<li>手动ACK确认</li>
</ul>
</li>
<li><strong>幂等性处理</strong>:<ul>
<li>布隆过滤器 + Redis Set记录已处理消息ID</li>
<li>数据库维护消息表（利用ACID）</li>
</ul>
</li>
</ul>
<p><strong>2. 评论功能</strong></p>
<ul>
<li><strong>查询评论列表</strong>:<ul>
<li>过滤条件：parentId&#x3D;0（一级评论）、status&#x3D;1（正常）、auditStatus&#x3D;1（审核通过）</li>
<li>排序规则：按点赞数和创建时间倒序</li>
<li>分页查询</li>
</ul>
</li>
<li><strong>TODO</strong>: 判断当前用户是否对评论点赞（Kafka + 双写一致性）</li>
</ul>
<p><strong>3. 弹幕功能（待实现）</strong></p>
<ul>
<li>实时弹幕发送</li>
<li>弹幕时间轴定位</li>
<li>敏感词过滤</li>
</ul>
<p><strong>4. 分享与举报（待实现）</strong></p>
<ul>
<li>多平台分享统计</li>
<li>内容举报与审核</li>
</ul>
<h4 id="3-3-4-数据模型（9张表）"><a href="#3-3-4-数据模型（9张表）" class="headerlink" title="3.3.4 数据模型（9张表）"></a>3.3.4 数据模型（9张表）</h4><table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
<th>核心字段</th>
</tr>
</thead>
<tbody><tr>
<td>user_likes</td>
<td>用户点赞记录</td>
<td>likeId, userId, targetId, targetType(短剧&#x2F;剧集&#x2F;评论&#x2F;弹幕), status(0取消&#x2F;1有效)</td>
</tr>
<tr>
<td>comments</td>
<td>评论表</td>
<td>commentId, userId, dramaId, episodeId, content, parentId, rootId, likeCount, status, auditStatus</td>
</tr>
<tr>
<td>content_statistics</td>
<td>内容统计</td>
<td>statId, contentId, contentType, commentCount, danmakuCount, likeCount, hotScore</td>
</tr>
<tr>
<td>danmaku</td>
<td>弹幕表</td>
<td>danmakuId, episodeId, userId, content, timePoint, color, position, fontSize, speed</td>
</tr>
<tr>
<td>danmaku_filter_words</td>
<td>弹幕过滤词</td>
<td>wordId, word, status</td>
</tr>
<tr>
<td>user_dislikes</td>
<td>用户点踩记录</td>
<td>dislikeId, userId, targetId, targetType</td>
</tr>
<tr>
<td>share_records</td>
<td>分享记录</td>
<td>shareId, userId, contentId, contentType, sharePlatform</td>
</tr>
<tr>
<td>reports</td>
<td>举报记录</td>
<td>reportId, userId, contentId, contentType, reportReason, reportType, status</td>
</tr>
<tr>
<td>user_interaction_statistics</td>
<td>用户互动统计</td>
<td>statId, userId, totalLikes, totalComments, totalShares, totalCollections</td>
</tr>
</tbody></table>
<h4 id="3-3-5-Redis缓存架构"><a href="#3-3-5-Redis缓存架构" class="headerlink" title="3.3.5 Redis缓存架构"></a>3.3.5 Redis缓存架构</h4><p><strong>RedisService工具类</strong>:</p>
<ol>
<li><strong>缓存穿透解决方案</strong>:<ul>
<li>空占位符: “NULL”（TTL&#x3D;30分钟）</li>
</ul>
</li>
<li><strong>缓存雪崩解决方案</strong>:<ul>
<li>随机过期时间（0-99999秒）</li>
</ul>
</li>
<li><strong>分布式锁实现</strong>:<ul>
<li>Lua脚本保证原子性（SETNX + 过期时间）</li>
<li>释放锁时比较值再删除</li>
</ul>
</li>
</ol>
<p><strong>缓存Key设计</strong>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">HOME_EPISODES_FEATURED_CACHE_KEY</span> = <span class="hljs-string">&quot;home:episodes:featured:&#123;pageNum&#125;:&#123;pageSize&#125;&quot;</span><br><span class="hljs-attr">DRAMA_DETAIL_CACHE_KEY</span> = <span class="hljs-string">&quot;drama:detail:&#123;dramaId&#125;&quot;</span><br><span class="hljs-attr">DRAMA_EPISODES_CACHE_KEY</span> = <span class="hljs-string">&quot;drama:episodes:&#123;dramaId&#125;&quot;</span><br><span class="hljs-attr">LIKE_EPISODE_KEY</span> = <span class="hljs-string">&quot;like:episode:&#123;episodeId&#125;&quot;</span>  <span class="hljs-comment"># Set结构存储点赞用户ID</span><br><span class="hljs-attr">PHONE_VERIFY_CODE_KEY</span> = <span class="hljs-string">&quot;phone:code:&#123;phone&#125;&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-camunda-service（工作流服务）"><a href="#3-4-camunda-service（工作流服务）" class="headerlink" title="3.4 camunda-service（工作流服务）"></a>3.4 camunda-service（工作流服务）</h3><h4 id="3-4-1-服务定位"><a href="#3-4-1-服务定位" class="headerlink" title="3.4.1 服务定位"></a>3.4.1 服务定位</h4><p><strong>角色</strong>: 工作流引擎与审核编排服务</p>
<p><strong>核心职责</strong>:</p>
<ol>
<li>BPMN流程定义部署</li>
<li>短剧审核流程编排（AI审核 + 人工审核）</li>
<li>AI情感分析（Ollama模型）</li>
<li>审核流程管理（启动、查询、完成任务）</li>
<li>审核通过后触发后续任务（转码、数据入库）</li>
</ol>
<h4 id="3-4-2-技术架构"><a href="#3-4-2-技术架构" class="headerlink" title="3.4.2 技术架构"></a>3.4.2 技术架构</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs scss">Controller层<br>  ├── ProcessDeployController (流程部署)<br>  └── ProcessManagerController (流程管理)<br>       ↓<br>Service层<br>  ├── ProcessManagerServiceImpl (流程管理服务)<br>  └── OllamaEmotionalAnalysisServiceImpl (情感分析服务)<br>       ↓<br>Biz层（业务委托处理器）<br>  └── CamundaJavaDelegateHandler<br>       ├── aiCheck (AI审核)<br>       ├── updateDramaAuthStatus (更新审核状态)<br>       ├── tencentVodTranslate (触发转码)<br>       └── ragDataHandler (RAG数据入库)<br>       ↓<br>Feign客户端<br>  └── ContentFeignClient → <span class="hljs-attribute">content</span>-service<br>       ↓<br>Camunda引擎<br>  ├── RepositoryService (流程部署)<br>  ├── RuntimeService (流程启动)<br>  └── TaskService (任务管理)<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-短剧审核流程（DramaAuthProcess）"><a href="#3-4-3-短剧审核流程（DramaAuthProcess）" class="headerlink" title="3.4.3 短剧审核流程（DramaAuthProcess）"></a>3.4.3 短剧审核流程（DramaAuthProcess）</h4><p><strong>BPMN流程定义</strong>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs">开始 → AI内容审核 → 人工审核 → 审核决策网关<br>                                    ├─ 不通过 → 更新数据库状态 → 结束<br>                                    └─ 通过 → 并行网关<br>                                              ├─ 腾讯云转码<br>                                              └─ RAG数据入库<br>                                              ↓<br>                                         并行网关汇聚<br>                                              ↓<br>                                         更新数据库状态<br>                                              ↓<br>                                            结束<br></code></pre></td></tr></table></figure>

<p><strong>流程变量</strong>:</p>
<ul>
<li><strong>输入变量</strong>: dramaId, title, description</li>
<li><strong>AI审核结果</strong>: titleAuthResult, descriptionAuthResult</li>
<li><strong>人工审核结果</strong>: approve(Boolean), auditStatus, auditReason</li>
</ul>
<p><strong>条件表达式</strong>:</p>
<ul>
<li>审核不通过: <code>$&#123;!approve&#125;</code></li>
<li>审核通过: <code>$&#123;approve&#125;</code></li>
</ul>
<p><strong>核心节点详解</strong>:</p>
<ol>
<li><p><strong>AI内容审核（Service Task）</strong>:</p>
<ul>
<li>JavaDelegate: <code>$&#123;aiCheck&#125;</code></li>
<li>功能: 使用Ollama AI模型对标题和简介进行情感分析</li>
<li>结果: 0-负面, 1-正面</li>
</ul>
</li>
<li><p><strong>人工审核（User Task）</strong>:</p>
<ul>
<li>任务名称: “人工审核”</li>
<li>审核员手动执行审核</li>
<li>提交审核结果（通过&#x2F;不通过、原因）</li>
</ul>
</li>
<li><p><strong>腾讯云转码（Service Task）</strong>:</p>
<ul>
<li>JavaDelegate: <code>$&#123;tecentVodTranslator&#125;</code></li>
<li>功能: 触发content-service的视频转码接口</li>
</ul>
</li>
<li><p><strong>RAG数据入库（Service Task）</strong>:</p>
<ul>
<li>JavaDelegate: <code>$&#123;ragDataHandler&#125;</code></li>
<li>功能: 将审核通过的数据入RAG知识库（待实现）</li>
</ul>
</li>
<li><p><strong>更新数据库状态（Service Task）</strong>:</p>
<ul>
<li>JavaDelegate: <code>$&#123;updateDramaAuthStatus&#125;</code></li>
<li>功能: 调用content-service更新审核状态</li>
</ul>
</li>
</ol>
<h4 id="3-4-4-API接口清单"><a href="#3-4-4-API接口清单" class="headerlink" title="3.4.4 API接口清单"></a>3.4.4 API接口清单</h4><table>
<thead>
<tr>
<th>接口路径</th>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>/workflow/deploy</code></td>
<td>POST</td>
<td>部署BPMN流程文件</td>
</tr>
<tr>
<td><code>/workflow/process/dramaAuth/start</code></td>
<td>POST</td>
<td>启动短剧审核流程</td>
</tr>
<tr>
<td><code>/workflow/process/variables/&#123;processId&#125;</code></td>
<td>GET</td>
<td>获取流程变量</td>
</tr>
<tr>
<td><code>/workflow/process/manual/authTask</code></td>
<td>PUT</td>
<td>执行人工审核任务</td>
</tr>
</tbody></table>
<h4 id="3-4-5-AI能力集成"><a href="#3-4-5-AI能力集成" class="headerlink" title="3.4.5 AI能力集成"></a>3.4.5 AI能力集成</h4><p><strong>Ollama情感分析</strong>:</p>
<ul>
<li><strong>模型</strong>: 本地部署的Ollama模型</li>
<li><strong>输入</strong>: 文本（标题或简介）</li>
<li><strong>输出</strong>: 0-负面, 1-正面</li>
<li><strong>系统提示词</strong>: 指导AI识别正负面情感</li>
</ul>
<p><strong>Spring AI配置</strong>:</p>
<ul>
<li><code>OllamaChatModel</code>: Ollama客户端</li>
<li><code>Prompt</code>: 构建System Message + User Message</li>
<li>返回结果转换为整数</li>
</ul>
<hr>
<h2 id="四、核心业务流程"><a href="#四、核心业务流程" class="headerlink" title="四、核心业务流程"></a>四、核心业务流程</h2><h3 id="4-1-短剧发布与审核完整流程"><a href="#4-1-短剧发布与审核完整流程" class="headerlink" title="4.1 短剧发布与审核完整流程"></a>4.1 短剧发布与审核完整流程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs markdown">┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段1：短剧发布（content-service）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br>用户提交短剧信息（基本信息+分类+标签+演员+剧集）<br>  ↓<br>PublishController接收请求<br>  ↓<br>DramaPublishService开启事务<br>  ↓<br><span class="hljs-bullet">1.</span> 保存短剧信息 → dramas表 → 生成dramaId<br><span class="hljs-bullet">2.</span> 保存短剧与分类关联 → drama<span class="hljs-emphasis">_categories表</span><br><span class="hljs-emphasis">3. 保存短剧与标签关联 → drama_</span>tags表<br><span class="hljs-bullet">4.</span> 保存短剧与演员关联 → drama<span class="hljs-emphasis">_actors表（新演员先插入actors表）</span><br><span class="hljs-emphasis">5. 保存剧集信息 → episodes表</span><br><span class="hljs-emphasis">6. 启动Camunda审核流程 → Feign调用camunda-service</span><br><span class="hljs-emphasis">7. 保存审核流程关系 → drama_</span>auth表（记录processId）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段2：AI自动审核（camunda-service）                                  │<br>└─────────────────────────────────────────────────────────────────────┘<br>Camunda流程启动 → 执行AI内容审核节点<br>  ↓<br>CamundaJavaDelegateHandler.aiCheck()<br>  ↓<br><span class="hljs-bullet">1.</span> 从流程变量获取dramaId、title、description<br><span class="hljs-bullet">2.</span> 调用Ollama情感分析服务分析标题 → titleAuthResult (0/1)<br><span class="hljs-bullet">3.</span> 调用Ollama情感分析服务分析简介 → descriptionAuthResult (0/1)<br><span class="hljs-bullet">4.</span> 将AI审核结果存入流程变量<br>  ↓<br>进入人工审核节点（User Task）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段3：人工审核（camunda-service）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br>审核人员通过管理后台查看待审核短剧<br>  ↓<br>调用 /workflow/process/manual/authTask 接口<br>  ↓<br>ProcessManagerService执行任务：<br><span class="hljs-bullet">1.</span> 查询当前待处理任务<br><span class="hljs-bullet">2.</span> 任务领取（claim）<br><span class="hljs-bullet">3.</span> 完成任务并提交审核结果（approve, auditStatus, auditReason）<br>  ↓<br>流程进入决策网关<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段4a：审核不通过分支                                                │<br>└─────────────────────────────────────────────────────────────────────┘<br>审核决策网关判断：approve = false<br>  ↓<br>执行 updateDramaAuthStatus 节点<br>  ↓<br>CamundaJavaDelegateHandler.updateDramaAuthStatus()<br>  ↓<br><span class="hljs-bullet">1.</span> 构建DramaAuthCompleteDto对象<br><span class="hljs-bullet">2.</span> Feign调用content-service的 /dramas/updateDramaAuthStatus 接口<br><span class="hljs-bullet">3.</span> 更新dramas表的审核状态（auditStatus=2，auditReason=原因）<br><span class="hljs-bullet">4.</span> 更新drama<span class="hljs-emphasis">_auth表</span><br><span class="hljs-emphasis">  ↓</span><br><span class="hljs-emphasis">流程结束</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="hljs-emphasis">│ 阶段4b：审核通过分支                                                  │</span><br><span class="hljs-emphasis">└─────────────────────────────────────────────────────────────────────┘</span><br><span class="hljs-emphasis">审核决策网关判断：approve = true</span><br><span class="hljs-emphasis">  ↓</span><br><span class="hljs-emphasis">进入并行网关（同时执行两个任务）</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">┌──────────────────────────┐    ┌──────────────────────────┐</span><br><span class="hljs-emphasis">│ 任务1：腾讯云视频转码     │    │ 任务2：RAG数据入库        │</span><br><span class="hljs-emphasis">│ (tecentVodTranslator)    │    │ (ragDataHandler)         │</span><br><span class="hljs-emphasis">└──────────────────────────┘    └──────────────────────────┘</span><br><span class="hljs-emphasis">         ↓                               ↓</span><br><span class="hljs-emphasis">CamundaJavaDelegateHandler           CamundaJavaDelegateHandler</span><br><span class="hljs-emphasis">.tencentVodTranslate()               .ragDataHandler()</span><br><span class="hljs-emphasis">         ↓                               ↓</span><br><span class="hljs-emphasis">Feign调用content-service             打印日志（待实现）</span><br><span class="hljs-emphasis">/tencent/vod/translate?dramaId=xxx</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">XXL-Job定时任务开始转码</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">     (详见4.2)</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="hljs-emphasis">│ 并行网关汇聚（等待两个任务完成）                                       │</span><br><span class="hljs-emphasis">└─────────────────────────────────────────────────────────────────────┘</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">执行 updateDramaAuthStatus 节点</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">CamundaJavaDelegateHandler.updateDramaAuthStatus()</span><br><span class="hljs-emphasis">         ↓</span><br><span class="hljs-emphasis">1. 更新dramas表的审核状态（auditStatus=1）</span><br><span class="hljs-emphasis">2. 更新drama_</span>auth表<br><span class="hljs-bullet">3.</span> 将dramaId添加到BloomFilter<br><span class="hljs-code">         ↓</span><br><span class="hljs-code">流程结束</span><br></code></pre></td></tr></table></figure>

<h4 id="Mermaid时序图"><a href="#Mermaid时序图" class="headerlink" title="Mermaid时序图"></a>Mermaid时序图</h4><pre><code class=" mermaid">sequenceDiagram
    participant User as 用户
    participant Content as content-service
    participant DB as MySQL数据库
    participant Camunda as camunda-service
    participant Ollama as Ollama AI
    participant Admin as 审核人员
    participant XXL as XXL-Job

    Note over User,XXL: 阶段1：短剧发布
    User-&gt;&gt;Content: 提交短剧信息
    activate Content
    Content-&gt;&gt;DB: 开启事务
    Content-&gt;&gt;DB: 1. 保存短剧信息(dramas)
    Content-&gt;&gt;DB: 2. 保存分类关联(drama_categories)
    Content-&gt;&gt;DB: 3. 保存标签关联(drama_tags)
    Content-&gt;&gt;DB: 4. 保存演员关联(drama_actors)
    Content-&gt;&gt;DB: 5. 保存剧集信息(episodes)

    Note over Content,Camunda: 启动审核流程
    Content-&gt;&gt;Camunda: Feign调用启动审核流程
    activate Camunda
    Camunda--&gt;&gt;Content: 返回processId
    Content-&gt;&gt;DB: 6. 保存审核流程关系(drama_auth)
    Content-&gt;&gt;DB: 提交事务
    Content--&gt;&gt;User: 发布成功
    deactivate Content

    Note over Camunda,Ollama: 阶段2：AI自动审核
    Camunda-&gt;&gt;Camunda: 执行AI内容审核节点
    Camunda-&gt;&gt;Ollama: 分析标题情感
    Ollama--&gt;&gt;Camunda: titleAuthResult(0/1)
    Camunda-&gt;&gt;Ollama: 分析简介情感
    Ollama--&gt;&gt;Camunda: descriptionAuthResult(0/1)
    Camunda-&gt;&gt;Camunda: 存入流程变量

    Note over Camunda,Admin: 阶段3：人工审核
    Camunda-&gt;&gt;Admin: 分配人工审核任务
    Admin-&gt;&gt;Camunda: 提交审核结果(approve)

    alt 审核不通过
        Note over Camunda,Content: 阶段4a：审核不通过
        Camunda-&gt;&gt;Camunda: 执行updateDramaAuthStatus
        Camunda-&gt;&gt;Content: Feign调用更新审核状态
        activate Content
        Content-&gt;&gt;DB: 更新dramas审核状态(rejected)
        Content-&gt;&gt;DB: 更新drama_auth表
        Content--&gt;&gt;Camunda: 更新成功
        deactivate Content
        Camunda-&gt;&gt;Camunda: 流程结束
    else 审核通过
        Note over Camunda,XXL: 阶段4b：审核通过
        Camunda-&gt;&gt;Camunda: 进入并行网关

        par 并行任务1：视频转码
            Camunda-&gt;&gt;Content: Feign调用触发转码
            activate Content
            Content-&gt;&gt;XXL: 创建转码任务
            XXL--&gt;&gt;Content: 任务创建成功
            deactivate Content
        and 并行任务2：RAG数据入库
            Camunda-&gt;&gt;Camunda: 执行ragDataHandler
            Note right of Camunda: 待实现
        end

        Note over Camunda,Content: 并行网关汇聚
        Camunda-&gt;&gt;Camunda: 执行updateDramaAuthStatus
        Camunda-&gt;&gt;Content: Feign调用更新审核状态
        activate Content
        Content-&gt;&gt;DB: 更新dramas审核状态(approved)
        Content-&gt;&gt;DB: 更新drama_auth表
        Content-&gt;&gt;Content: 添加dramaId到BloomFilter
        Content--&gt;&gt;Camunda: 更新成功
        deactivate Content
        Camunda-&gt;&gt;Camunda: 流程结束
    end
    deactivate Camunda
</code></pre>

<h3 id="4-2-视频转码流程（content-service）"><a href="#4-2-视频转码流程（content-service）" class="headerlink" title="4.2 视频转码流程（content-service）"></a>4.2 视频转码流程（content-service）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs markdown">┌─────────────────────────────────────────────────────────────────────┐<br>│ 转码触发：camunda-service调用content-service转码接口                  │<br>└─────────────────────────────────────────────────────────────────────┘<br>TencentVodController.translate(dramaId)<br>  ↓<br>创建XXL-Job任务（TranslateJob）<br>  ↓<br>XXL-Job调度执行<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 任务1：信息流转码（竖屏短视频格式）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">1.</span> 查询dramas表，获取trailerUrl（预告片URL）或第一集videoUrl<br><span class="hljs-bullet">2.</span> 从MinIO下载视频到临时文件<br><span class="hljs-bullet">3.</span> 上传到腾讯云VOD<br><span class="hljs-bullet">4.</span> 指定信息流转码模板ID<br><span class="hljs-bullet">5.</span> 轮询PullEvents拉取转码事件<br><span class="hljs-bullet">6.</span> 获取转码结果URL<br><span class="hljs-bullet">7.</span> 更新dramas.trailerInfoflowUrl<br><span class="hljs-bullet">8.</span> ConfirmEvents确认事件<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 任务2：画质转码（1080p/720p/480p）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">1.</span> 查询episodes表，获取所有剧集<br><span class="hljs-bullet">2.</span> 批量处理每一集：<br>   a. 从MinIO下载视频到临时文件<br>   b. 上传到腾讯云VOD<br>   c. 指定画质转码模板ID（1080p/720p/480p）<br>   d. 轮询PullEvents拉取转码事件<br>   e. 获取转码结果URL（3个清晰度）<br>   f. 更新episodes表的videoUrlHd/Sd/Ld字段<br>   g. ConfirmEvents确认事件<br><span class="hljs-bullet">3.</span> 完成所有剧集转码<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 转码完成                                                             │<br>└─────────────────────────────────────────────────────────────────────┘<br>短剧状态：已审核+已转码 → 可以上架展示<br></code></pre></td></tr></table></figure>

<h4 id="Mermaid流程图"><a href="#Mermaid流程图" class="headerlink" title="Mermaid流程图"></a>Mermaid流程图</h4><pre><code class=" mermaid">sequenceDiagram
    participant Camunda as camunda-service
    participant Content as content-service
    participant XXL as XXL-Job
    participant DB as MySQL
    participant MinIO as MinIO对象存储
    participant VOD as 腾讯云VOD

    Note over Camunda,Content: 转码触发
    Camunda-&gt;&gt;Content: Feign调用/tencent/vod/translate
    activate Content
    Content-&gt;&gt;XXL: 创建转码任务
    Content--&gt;&gt;Camunda: 任务创建成功
    deactivate Content

    Note over XXL,VOD: XXL-Job执行转码任务
    XXL-&gt;&gt;XXL: 调度执行TranslateJob

    rect rgb(240, 248, 255)
        Note over XXL,VOD: 任务1：信息流转码
        XXL-&gt;&gt;DB: 查询dramas表获取trailerUrl
        DB--&gt;&gt;XXL: 返回视频URL
        XXL-&gt;&gt;MinIO: 下载视频到临时文件
        MinIO--&gt;&gt;XXL: 返回视频文件
        XXL-&gt;&gt;VOD: 上传视频
        VOD--&gt;&gt;XXL: 返回fileId
        XXL-&gt;&gt;VOD: 指定信息流转码模板

        loop 轮询转码状态
            XXL-&gt;&gt;VOD: PullEvents拉取转码事件
            VOD--&gt;&gt;XXL: 返回转码进度
        end

        VOD--&gt;&gt;XXL: 返回转码结果URL
        XXL-&gt;&gt;VOD: ConfirmEvents确认事件
        XXL-&gt;&gt;DB: 更新dramas.trailerInfoflowUrl
    end

    rect rgb(255, 250, 240)
        Note over XXL,VOD: 任务2：画质转码(1080p/720p/480p)
        XXL-&gt;&gt;DB: 查询episodes表获取所有剧集
        DB--&gt;&gt;XXL: 返回剧集列表

        loop 每一集剧集
            XXL-&gt;&gt;MinIO: 下载剧集视频
            MinIO--&gt;&gt;XXL: 返回视频文件
            XXL-&gt;&gt;VOD: 上传视频
            VOD--&gt;&gt;XXL: 返回fileId
            XXL-&gt;&gt;VOD: 指定画质转码模板(1080p/720p/480p)

            loop 轮询转码状态
                XXL-&gt;&gt;VOD: PullEvents拉取转码事件
                VOD--&gt;&gt;XXL: 返回转码进度
            end

            VOD--&gt;&gt;XXL: 返回3个清晰度URL
            XXL-&gt;&gt;VOD: ConfirmEvents确认事件
            XXL-&gt;&gt;DB: 更新episodes(videoUrlHd/Sd/Ld)
        end
    end

    Note over XXL,DB: 转码完成
    XXL-&gt;&gt;DB: 短剧状态: 已审核+已转码
</code></pre>

<h3 id="4-3-用户登录流程（user-service）"><a href="#4-3-用户登录流程（user-service）" class="headerlink" title="4.3 用户登录流程（user-service）"></a>4.3 用户登录流程（user-service）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs markdown">┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段1：发送验证码                                                     │<br>└─────────────────────────────────────────────────────────────────────┘<br>用户输入手机号 → 点击&quot;获取验证码&quot;<br>  ↓<br>调用 /api/send-code 接口<br>  ↓<br>VerifyCodeServiceImpl.sendVerifyCode(phone)<br>  ↓<br><span class="hljs-bullet">1.</span> 生成6位随机数字验证码<br><span class="hljs-bullet">2.</span> 调用SmsTemplate发送短信（阿里云短信服务）<br><span class="hljs-bullet">3.</span> 验证码存入Redis（key: phone:verify:code:&#123;phone&#125;，TTL=5分钟）<br><span class="hljs-bullet">4.</span> 返回成功响应（包含expireTime）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段2：验证码登录                                                     │<br>└─────────────────────────────────────────────────────────────────────┘<br>用户输入手机号+验证码 → 点击&quot;登录&quot;<br>  ↓<br>调用 /api/login 接口（LoginReqVo: phone, code）<br>  ↓<br>UserAuthServiceImpl.login(LoginReqVo)<br>  ↓<br><span class="hljs-bullet">1.</span> 从Redis查询验证码（key: phone:verify:code:&#123;phone&#125;）<br><span class="hljs-bullet">2.</span> 验证码不存在或不匹配 → 返回&quot;验证码错误&quot;<br><span class="hljs-bullet">3.</span> 验证通过 → 删除Redis中的验证码（防止重复使用）<br><span class="hljs-bullet">4.</span> 查询users表（phone = ?）<br><span class="hljs-bullet">5.</span> 用户不存在？<br>   ├─ 是 → 调用register(phone)<br>   │       ├─ 生成随机昵称（游客+6位随机数）<br>   │       ├─ 插入users表<br>   │       └─ 返回userId<br>   └─ 否 → 直接获取userId<br><span class="hljs-bullet">6.</span> Sa-Token登录：StpUtil.login(userId, LoginConfig携带phone、nickname等扩展信息)<br><span class="hljs-bullet">7.</span> 生成JWT令牌：StpUtil.getTokenValue()<br><span class="hljs-bullet">8.</span> 计算过期时间：StpUtil.getTokenTimeout()<br><span class="hljs-bullet">9.</span> 返回LoginResVo（token, expires）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段3：后续请求携带Token                                              │<br>└─────────────────────────────────────────────────────────────────────┘<br>客户端后续请求：<br>  Header: Authorization: Bearer &#123;token&#125;<br>  ↓<br>Sa-Token拦截器验证Token<br>  ↓<br>StpUtil.isLogin() → true<br>  ↓<br>业务代码获取当前用户：StpUtil.getLoginIdAsLong()<br></code></pre></td></tr></table></figure>

<h4 id="Mermaid时序图-1"><a href="#Mermaid时序图-1" class="headerlink" title="Mermaid时序图"></a>Mermaid时序图</h4><pre><code class=" mermaid">sequenceDiagram
    participant User as 用户
    participant App as App客户端
    participant UserSvc as user-service
    participant Redis as Redis
    participant SMS as 阿里云短信
    participant DB as MySQL
    participant SaToken as Sa-Token

    Note over User,SMS: 阶段1：发送验证码
    User-&gt;&gt;App: 输入手机号，点击&quot;获取验证码&quot;
    App-&gt;&gt;UserSvc: POST /api/send-code
    activate UserSvc
    UserSvc-&gt;&gt;UserSvc: 生成6位随机验证码
    UserSvc-&gt;&gt;SMS: 发送短信验证码
    SMS--&gt;&gt;UserSvc: 发送成功
    UserSvc-&gt;&gt;Redis: 存储验证码(TTL=5分钟)
    Redis--&gt;&gt;UserSvc: 存储成功
    UserSvc--&gt;&gt;App: 返回成功(expireTime)
    deactivate UserSvc
    App--&gt;&gt;User: 显示&quot;验证码已发送&quot;

    Note over User,SaToken: 阶段2：验证码登录
    User-&gt;&gt;App: 输入验证码，点击&quot;登录&quot;
    App-&gt;&gt;UserSvc: POST /api/login &#123;phone, code&#125;
    activate UserSvc

    UserSvc-&gt;&gt;Redis: 查询验证码
    Redis--&gt;&gt;UserSvc: 返回验证码

    alt 验证码错误或过期
        UserSvc--&gt;&gt;App: 返回&quot;验证码错误&quot;
        App--&gt;&gt;User: 显示错误提示
    else 验证码正确
        UserSvc-&gt;&gt;Redis: 删除验证码(防止重复使用)
        UserSvc-&gt;&gt;DB: 查询users表(phone)
        DB--&gt;&gt;UserSvc: 返回用户信息

        alt 用户不存在
            UserSvc-&gt;&gt;UserSvc: 生成随机昵称(游客+6位数)
            UserSvc-&gt;&gt;DB: 插入users表
            DB--&gt;&gt;UserSvc: 返回userId
        else 用户已存在
            UserSvc-&gt;&gt;UserSvc: 获取userId
        end

        UserSvc-&gt;&gt;SaToken: StpUtil.login(userId, 扩展信息)
        activate SaToken
        SaToken-&gt;&gt;Redis: 存储Token会话信息
        SaToken--&gt;&gt;UserSvc: 返回JWT Token
        deactivate SaToken

        UserSvc--&gt;&gt;App: 返回&#123;token, expires&#125;
        deactivate UserSvc
        App-&gt;&gt;App: 存储Token到本地
        App--&gt;&gt;User: 登录成功，跳转首页
    end

    Note over User,SaToken: 阶段3：后续请求携带Token
    User-&gt;&gt;App: 浏览首页
    App-&gt;&gt;UserSvc: GET /api/episodes/featured&lt;br/&gt;Header: Authorization: Bearer &#123;token&#125;
    activate UserSvc
    UserSvc-&gt;&gt;SaToken: 验证Token
    activate SaToken
    SaToken-&gt;&gt;Redis: 查询Token会话信息
    Redis--&gt;&gt;SaToken: 返回会话信息
    SaToken--&gt;&gt;UserSvc: 验证通过，返回userId
    deactivate SaToken
    UserSvc-&gt;&gt;UserSvc: 获取当前用户ID
    UserSvc-&gt;&gt;UserSvc: 执行业务逻辑
    UserSvc--&gt;&gt;App: 返回数据
    deactivate UserSvc
    App--&gt;&gt;User: 展示数据
</code></pre>

<h3 id="4-4-首页精选视频流程（user-service-content-service）"><a href="#4-4-首页精选视频流程（user-service-content-service）" class="headerlink" title="4.4 首页精选视频流程（user-service + content-service）"></a>4.4 首页精选视频流程（user-service + content-service）</h3><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段1：用户请求首页精选（user-service）                                │<br>└─────────────────────────────────────────────────────────────────────┘<br>App请求 /api/episodes/featured?pageNum=1&amp;pageSize=10<br>  ↓<br>AppHomeController.getEpisodesFeatured(PageReqDto)<br>  ↓<br>DramaBizServiceImpl.getEpisodesFeatured(PageReqDto)<br>  ↓<br><span class="hljs-number">1.</span> 拼接缓存<span class="hljs-keyword">Key</span>: <span class="hljs-string">&quot;home:episodes:featured:1:10&quot;</span><br><span class="hljs-number">2.</span> 查询Redis缓存<br><span class="hljs-number">3.</span> 缓存命中？<br>   ├─ 是 → 直接返回缓存数据 → 跳转到阶段<span class="hljs-number">3</span><br>   └─ 否 → 继续下一步<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段<span class="hljs-number">2</span>：远程调用content-service获取数据                                │<br>└─────────────────────────────────────────────────────────────────────┘<br>Feign调用 ContentFeignClient.getEpisodesFeatured(PageReqDto)<br>  ↓<br>content-service的AppHomeDataController接收请求<br>  ↓<br>DramaHomeServiceImpl.getEpisodesFeatured(pageNum, pageSize)<br>  ↓<br><span class="hljs-number">1.</span> 查询数据库（dramas表）：<br>   - 条件：status=<span class="hljs-number">1</span>（已上架）、auditStatus=<span class="hljs-number">1</span>（审核通过）<br>   - 分页：<span class="hljs-keyword">offset</span>=(pageNum<span class="hljs-number">-1</span>)*pageSize, <span class="hljs-keyword">limit</span>=pageSize<br>   - 排序：按创建时间倒序<br><span class="hljs-number">2.</span> 对每个短剧：<br>   a. 查询信息流剧集（trailerInfoflowUrl或第一集）<br>   b. 查询演员信息（关联drama_actors、actors表）<br>   c. 查询标签列表（关联drama_tags、tags表）<br>   d. 查询分类列表（关联drama_categories、categories表）<br>   <span class="hljs-built_in">e</span>. 组装HomeFeaturedDto对象<br><span class="hljs-number">3.</span> 计算分页信息（total, hasMore）<br><span class="hljs-number">4.</span> 返回数据给<span class="hljs-keyword">user</span>-service<br>  ↓<br><span class="hljs-keyword">user</span>-service接收到数据<br>  ↓<br><span class="hljs-number">1.</span> 将数据写入Redis缓存（TTL=<span class="hljs-number">7</span>天+随机<span class="hljs-number">5</span>位数秒）<br><span class="hljs-number">2.</span> 继续下一步<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段<span class="hljs-number">3</span>：查询点赞状态（<span class="hljs-keyword">user</span>-service）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br>遍历HomeFeaturedDto列表<br>  ↓<br>对每个剧集：<br><span class="hljs-number">1.</span> 获取episodeId<br><span class="hljs-number">2.</span> 判断用户是否登录？<br>   ├─ 否 → liked = <span class="hljs-literal">false</span><br>   └─ 是 → 查询Redis <span class="hljs-keyword">Set</span>（<span class="hljs-keyword">key</span>: <span class="hljs-string">&quot;like:episode:&#123;episodeId&#125;&quot;</span>）<br>           判断当前userId是否在<span class="hljs-keyword">Set</span>中<br>           ├─ 在 → liked = <span class="hljs-literal">true</span><br>           └─ 不在 → liked = <span class="hljs-literal">false</span><br><span class="hljs-number">3.</span> 设置liked字段<br>  ↓<br>返回完整数据给App端<br></code></pre></td></tr></table></figure>

<h4 id="Mermaid时序图-2"><a href="#Mermaid时序图-2" class="headerlink" title="Mermaid时序图"></a>Mermaid时序图</h4><pre><code class=" mermaid">sequenceDiagram
    participant App as App客户端
    participant UserSvc as user-service
    participant Redis as Redis缓存
    participant ContentSvc as content-service
    participant DB as MySQL

    Note over App,Redis: 阶段1：查询缓存
    App-&gt;&gt;UserSvc: GET /api/episodes/featured?pageNum=1&amp;pageSize=10
    activate UserSvc
    UserSvc-&gt;&gt;UserSvc: 拼接缓存Key&lt;br/&gt;&quot;home:episodes:featured:1:10&quot;
    UserSvc-&gt;&gt;Redis: 查询缓存
    Redis--&gt;&gt;UserSvc: 返回缓存结果

    alt 缓存命中
        UserSvc-&gt;&gt;UserSvc: 获取缓存数据
        Note over UserSvc: 跳转到阶段3
    else 缓存未命中
        Note over UserSvc,DB: 阶段2：远程调用content-service
        UserSvc-&gt;&gt;ContentSvc: Feign调用getEpisodesFeatured
        activate ContentSvc

        ContentSvc-&gt;&gt;DB: 查询dramas表&lt;br/&gt;(status=1, auditStatus=1, 分页)
        DB--&gt;&gt;ContentSvc: 返回短剧列表

        loop 每个短剧
            ContentSvc-&gt;&gt;DB: 查询信息流剧集(episodes)
            ContentSvc-&gt;&gt;DB: 查询演员信息(drama_actors + actors)
            ContentSvc-&gt;&gt;DB: 查询标签列表(drama_tags + tags)
            ContentSvc-&gt;&gt;DB: 查询分类列表(drama_categories + categories)
            DB--&gt;&gt;ContentSvc: 返回关联数据
            ContentSvc-&gt;&gt;ContentSvc: 组装HomeFeaturedDto
        end

        ContentSvc-&gt;&gt;ContentSvc: 计算分页信息(total, hasMore)
        ContentSvc--&gt;&gt;UserSvc: 返回数据列表
        deactivate ContentSvc

        UserSvc-&gt;&gt;Redis: 写入缓存(TTL=7天+随机时间)
        Redis--&gt;&gt;UserSvc: 写入成功
    end

    Note over UserSvc,Redis: 阶段3：查询点赞状态
    alt 用户未登录
        UserSvc-&gt;&gt;UserSvc: 所有剧集liked=false
    else 用户已登录
        UserSvc-&gt;&gt;UserSvc: 获取当前userId

        loop 遍历每个剧集
            UserSvc-&gt;&gt;Redis: 查询Set &quot;like:episode:&#123;episodeId&#125;&quot;
            Redis--&gt;&gt;UserSvc: 返回点赞用户集合

            alt userId在Set中
                UserSvc-&gt;&gt;UserSvc: 设置liked=true
            else userId不在Set中
                UserSvc-&gt;&gt;UserSvc: 设置liked=false
            end
        end
    end

    UserSvc--&gt;&gt;App: 返回完整数据(含点赞状态)
    deactivate UserSvc
    App-&gt;&gt;App: 渲染首页视频流
</code></pre>

<h3 id="4-5-短剧详情查询流程（user-service-content-service）"><a href="#4-5-短剧详情查询流程（user-service-content-service）" class="headerlink" title="4.5 短剧详情查询流程（user-service + content-service）"></a>4.5 短剧详情查询流程（user-service + content-service）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs markdown">┌─────────────────────────────────────────────────────────────────────┐<br>│ 完整缓存流程（三高防护）                                              │<br>└─────────────────────────────────────────────────────────────────────┘<br>App请求 /api/dramas/&#123;dramaId&#125;<br>  ↓<br>AppHomeController.getDramaDetail(dramaId)<br>  ↓<br>DramaBizServiceImpl.getDramaDetail(dramaId) [@CacheData注解]<br>  ↓<br>CacheDataAspect切面拦截<br>  ↓<br><span class="hljs-bullet">1.</span> 拼接缓存Key: &quot;drama:detail:&#123;dramaId&#125;&quot;<br><span class="hljs-bullet">2.</span> 查询Redis缓存<br><span class="hljs-bullet">3.</span> 缓存命中？<br>   ├─ 是 → 直接返回缓存数据 → 结束<br>   └─ 否 → 继续下一步（缓存未命中）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 防护1：布隆过滤器防止缓存穿透                                          │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">4.</span> 查询布隆过滤器（bloomFilterKey: &quot;bloom:filter:dramas:id&quot;）<br><span class="hljs-bullet">5.</span> 布隆过滤器不存在该dramaId？<br>   ├─ 是 → 直接返回null（防止查询不存在的数据） → 结束<br>   └─ 否 → 继续下一步（dramaId可能存在）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 防护2：分布式锁防止缓存击穿                                            │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">6.</span> 尝试获取Redisson分布式锁（lockKey: &quot;lock:drama:detail:&#123;dramaId&#125;&quot;）<br><span class="hljs-bullet">7.</span> 获取锁成功？<br>   ├─ 是 → 继续下一步（当前线程负责查询数据库）<br>   └─ 否 → 等待2秒 → 重新查询Redis缓存 → 返回<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 查询数据库并回写缓存                                                  │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">8.</span> Feign调用ContentFeignClient.getDramaDetail(dramaId)<br><span class="hljs-bullet">9.</span> content-service查询数据库：<br>   a. 查询dramas表<br>   b. 查询演员信息<br>   c. 查询标签列表<br>   d. 组装HomeDramaInfoDto<br><span class="hljs-bullet">10.</span> 数据不存在？<br><span class="hljs-code">    ├─ 是 → 写入空占位符到Redis（TTL=30分钟） → 释放锁 → 返回null</span><br><span class="hljs-code">    └─ 否 → 继续下一步</span><br><span class="hljs-code"></span><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 防护3：随机过期时间防止缓存雪崩                                        │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-bullet">11.</span> 写入Redis缓存：<br><span class="hljs-bullet">    -</span> TTL = 7天 + 随机5位数秒（最大约19小时）<br><span class="hljs-bullet">    -</span> 避免大量key同时失效<br><span class="hljs-bullet">12.</span> 释放分布式锁<br><span class="hljs-bullet">13.</span> 返回数据<br></code></pre></td></tr></table></figure>

<h4 id="Mermaid流程图（三高防护机制）"><a href="#Mermaid流程图（三高防护机制）" class="headerlink" title="Mermaid流程图（三高防护机制）"></a>Mermaid流程图（三高防护机制）</h4><pre><code class=" mermaid">flowchart TD
    Start([App请求短剧详情]) --&gt; A[user-service接收请求]
    A --&gt; B[&quot;@CacheData切面拦截&quot;]
    B --&gt; C&#123;查询Redis缓存&#125;

    C --&gt;|缓存命中| End1([返回缓存数据])

    C --&gt;|缓存未命中| D&#123;&quot;查询布隆过滤器&lt;br/&gt;bloom:filter:dramas:id&quot;&#125;

    D --&gt;|dramaId不存在| End2([&quot;返回null&lt;br/&gt;防护1: 缓存穿透&quot;])

    D --&gt;|dramaId可能存在| E&#123;&quot;尝试获取分布式锁&lt;br/&gt;lock:drama:detail&quot;&#125;

    E --&gt;|获取锁失败| F[等待2秒]
    F --&gt; G&#123;重新查询缓存&#125;
    G --&gt;|有数据| End3([返回缓存数据])
    G --&gt;|无数据| End4([返回null])

    E --&gt;|获取锁成功| H[Feign调用content-service]
    H --&gt; I[查询MySQL数据库]
    I --&gt; J&#123;数据存在?&#125;

    J --&gt;|不存在| K[&quot;写入空占位符&lt;br/&gt;TTL:30分钟&quot;]
    K --&gt; L[释放分布式锁]
    L --&gt; End5([&quot;返回null&lt;br/&gt;防护1: 缓存穿透&quot;])

    J --&gt;|存在| M[&quot;写入Redis缓存&lt;br/&gt;TTL:7天+随机时间&quot;]
    M --&gt; N[释放分布式锁]
    N --&gt; End6([&quot;返回数据&lt;br/&gt;防护3: 缓存雪崩&quot;])

    style D fill:#e1f5ff
    style E fill:#fff4e1
    style M fill:#e8f5e9
    style K fill:#ffebee
</code></pre>

<p><strong>三高防护说明</strong>:</p>
<ul>
<li><strong>防护1（缓存穿透）</strong>: 布隆过滤器快速判断数据是否存在 + 空值缓存</li>
<li><strong>防护2（缓存击穿）</strong>: Redisson分布式锁，只有一个线程回源查询</li>
<li><strong>防护3（缓存雪崩）</strong>: 随机过期时间（7天+0-27小时），避免集体失效</li>
</ul>
<h3 id="4-6-点赞功能流程（user-service-interaction-service-Kafka）"><a href="#4-6-点赞功能流程（user-service-interaction-service-Kafka）" class="headerlink" title="4.6 点赞功能流程（user-service + interaction-service + Kafka）"></a>4.6 点赞功能流程（user-service + interaction-service + Kafka）</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs nix">┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段<span class="hljs-number">1</span>：用户点击点赞（user-service）                                    │<br>└─────────────────────────────────────────────────────────────────────┘<br>App请求 <span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>episodes<span class="hljs-operator">/</span>&#123;episodeId&#125;<span class="hljs-symbol">/like</span><br>  <span class="hljs-params">Body:</span> &#123; <span class="hljs-params">action:</span> <span class="hljs-string">&quot;like&quot;</span> &#125;  <span class="hljs-operator">//</span> 或 <span class="hljs-string">&quot;unlike&quot;</span><br>  <span class="hljs-params">Header:</span> <span class="hljs-params">Authorization:</span> Bearer &#123;token&#125;<br>  ↓<br>AppInteractionController.likeEpisode(episodeId, EpisodesLikeReqVo)<br>  ↓<br><span class="hljs-number">1</span>. Sa-Token登录校验：StpUtil.isLogin() → 未登录抛出异常<br><span class="hljs-number">2</span>. 获取当前用户ID：StpUtil.getLoginIdAsLong()<br>  ↓<br>LikeBizServiceImpl.likeEpisode(episodeId, reqVo)<br>  ↓<br><span class="hljs-number">3</span>. 构造LikeEvent事件对象：<br>   <span class="hljs-operator">-</span> <span class="hljs-params">episodeId:</span> 剧集ID<br>   <span class="hljs-operator">-</span> <span class="hljs-params">action:</span> <span class="hljs-string">&quot;like&quot;</span> 或 <span class="hljs-string">&quot;unlike&quot;</span><br>   <span class="hljs-operator">-</span> <span class="hljs-params">msgId:</span> <span class="hljs-literal">null</span>（生产者拦截器自动填充）<br>   <span class="hljs-operator">-</span> <span class="hljs-params">userId:</span> <span class="hljs-literal">null</span>（生产者拦截器自动填充）<br>   <span class="hljs-operator">-</span> <span class="hljs-params">timestamp:</span> <span class="hljs-literal">null</span>（生产者拦截器自动填充）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段<span class="hljs-number">2</span>：发送Kafka消息                                                  │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-number">4</span>. KafkaTemplate.send()：<br>   <span class="hljs-operator">-</span> <span class="hljs-params">Topic:</span> <span class="hljs-string">&quot;like-event-topic&quot;</span><br>   <span class="hljs-operator">-</span> <span class="hljs-params">Key:</span> <span class="hljs-string">&quot;like-event-&#123;episodeId&#125;-&#123;userId&#125;&quot;</span>（保证同一用户对同一剧集的操作顺序）<br>   <span class="hljs-operator">-</span> <span class="hljs-params">Value:</span> LikeEvent对象<br>  ↓<br><span class="hljs-number">5</span>. KafkaEventProducerInterceptor拦截器自动填充：<br>   <span class="hljs-operator">-</span> <span class="hljs-params">msgId:</span> IdUtil.getSnowflakeNextId()（雪花算法生成唯一ID）<br>   <span class="hljs-operator">-</span> <span class="hljs-params">userId:</span> StpUtil.getLoginIdAsLong()<br>   <span class="hljs-operator">-</span> <span class="hljs-params">timestamp:</span> System.currentTimeMillis()<br>  ↓<br><span class="hljs-number">6</span>. 消息发送到Kafka Broker<br><span class="hljs-number">7</span>. 返回成功响应给App（不等待消费完成）<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 阶段<span class="hljs-number">3</span>：Kafka消费者处理（user-service 和 interaction-service）          │<br>└─────────────────────────────────────────────────────────────────────┘<br><br>┌──────────────────────────────────────────────────────────────────┐<br>│ 消费者<span class="hljs-number">1</span>：user-service (LikeEventListener)                         │<br>└──────────────────────────────────────────────────────────────────┘<br><span class="hljs-number">8</span>. 监听<span class="hljs-params">Topic:</span> <span class="hljs-string">&quot;like-event-topic&quot;</span><br><span class="hljs-number">9</span>. 接收LikeEvent消息<br><span class="hljs-number">10</span>. 更新Redis缓存（首页精选视频缓存）：<br>    a. 查询Redis缓存（<span class="hljs-params">key:</span> <span class="hljs-string">&quot;home:episodes:featured:&#123;pageNum&#125;:&#123;pageSize&#125;&quot;</span>）<br>    b. 遍历短剧列表，找到对应的episodeId<br>    c. action <span class="hljs-operator">=</span> <span class="hljs-string">&quot;like&quot;</span> <span class="hljs-operator">?</span><br>       ├─ 是 → likeCount <span class="hljs-operator">+</span> <span class="hljs-number">1</span><br>       └─ 否 → likeCount <span class="hljs-operator">-</span> <span class="hljs-number">1</span><br>    d. 回写Redis缓存<br><span class="hljs-number">11</span>. 更新Redis Set（点赞状态）：<br>    a. <span class="hljs-params">key:</span> <span class="hljs-string">&quot;like:episode:&#123;episodeId&#125;&quot;</span><br>    b. action <span class="hljs-operator">=</span> <span class="hljs-string">&quot;like&quot;</span> <span class="hljs-operator">?</span><br>       ├─ 是 → sadd userId<br>       └─ 否 → srem userId<br><span class="hljs-number">12</span>. 手动ACK确认<br><br>┌──────────────────────────────────────────────────────────────────┐<br>│ 消费者<span class="hljs-number">2</span>：interaction-service (LikeEventListener)                  │<br>└──────────────────────────────────────────────────────────────────┘<br><span class="hljs-number">13</span>. 监听<span class="hljs-params">Topic:</span> <span class="hljs-string">&quot;like-event-topic&quot;</span><br><span class="hljs-number">14</span>. 接收LikeEvent消息<br><span class="hljs-number">15</span>. LikeBizServiceImpl.likeEpisode()：<br>    a. 查询user_likes表：<br>       <span class="hljs-operator">-</span> userId <span class="hljs-operator">=</span> <span class="hljs-operator">?</span><br>       <span class="hljs-operator">-</span> targetId <span class="hljs-operator">=</span> episodeId<br>       <span class="hljs-operator">-</span> targetType <span class="hljs-operator">=</span> <span class="hljs-number">2</span>（剧集）<br>    b. 记录存在？<br>       ├─ 是 → 更新status字段（action<span class="hljs-operator">=</span><span class="hljs-string">&quot;like&quot;</span> → <span class="hljs-number">1</span>, <span class="hljs-string">&quot;unlike&quot;</span> → <span class="hljs-number">0</span>）<br>       └─ 否 → 插入新记录<br><span class="hljs-number">16</span>. 更新Redis缓存（首页精选视频缓存中的点赞数）<br><span class="hljs-number">17</span>. 手动ACK确认<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 最终一致性保证                                                        │<br>└─────────────────────────────────────────────────────────────────────┘<br><span class="hljs-operator">-</span> 数据库持久化（interaction-service）<br><span class="hljs-operator">-</span> Redis缓存更新（user-service <span class="hljs-operator">+</span> interaction-service）<br><span class="hljs-operator">-</span> 幂等性保证：同一消息多次消费结果一致（数据库幂等更新 <span class="hljs-operator">+</span> Redis Set操作幂等）<br></code></pre></td></tr></table></figure>

<h4 id="Mermaid时序图（Kafka异步处理）"><a href="#Mermaid时序图（Kafka异步处理）" class="headerlink" title="Mermaid时序图（Kafka异步处理）"></a>Mermaid时序图（Kafka异步处理）</h4><pre><code class=" mermaid">sequenceDiagram
    participant App as App客户端
    participant UserSvc as user-service
    participant KafkaP as Kafka Producer
    participant Kafka as Kafka Broker&lt;br/&gt;(like-event-topic)
    participant UserConsumer as user-service&lt;br/&gt;LikeEventListener
    participant InterConsumer as interaction-service&lt;br/&gt;LikeEventListener
    participant Redis as Redis
    participant DB as MySQL

    Note over App,KafkaP: 阶段1：用户点击点赞
    App-&gt;&gt;UserSvc: POST /api/episodes/&#123;episodeId&#125;/like&lt;br/&gt;&#123;action: &quot;like&quot;&#125;
    activate UserSvc
    UserSvc-&gt;&gt;UserSvc: Sa-Token登录校验
    UserSvc-&gt;&gt;UserSvc: 获取userId

    Note over UserSvc,Kafka: 阶段2：发送Kafka消息
    UserSvc-&gt;&gt;KafkaP: 构造LikeEvent事件
    activate KafkaP
    KafkaP-&gt;&gt;KafkaP: 拦截器自动填充&lt;br/&gt;msgId(雪花ID), userId, timestamp
    KafkaP-&gt;&gt;Kafka: 发送消息&lt;br/&gt;Key: like-event-&#123;episodeId&#125;-&#123;userId&#125;
    deactivate KafkaP
    Kafka--&gt;&gt;UserSvc: 发送成功
    UserSvc--&gt;&gt;App: 返回成功响应(不等待消费)
    deactivate UserSvc
    App-&gt;&gt;App: 立即更新UI(乐观更新)

    Note over Kafka,DB: 阶段3：Kafka异步消费

    par 消费者1: user-service
        Kafka-&gt;&gt;UserConsumer: 推送LikeEvent消息
        activate UserConsumer

        UserConsumer-&gt;&gt;Redis: 查询首页缓存&lt;br/&gt;&quot;home:episodes:featured:*&quot;
        Redis--&gt;&gt;UserConsumer: 返回缓存数据

        alt action = &quot;like&quot;
            UserConsumer-&gt;&gt;UserConsumer: likeCount + 1
        else action = &quot;unlike&quot;
            UserConsumer-&gt;&gt;UserConsumer: likeCount - 1
        end

        UserConsumer-&gt;&gt;Redis: 更新缓存中的点赞数
        Redis--&gt;&gt;UserConsumer: 更新成功

        UserConsumer-&gt;&gt;Redis: 更新点赞状态Set&lt;br/&gt;&quot;like:episode:&#123;episodeId&#125;&quot;
        alt action = &quot;like&quot;
            Redis-&gt;&gt;Redis: sadd userId
        else action = &quot;unlike&quot;
            Redis-&gt;&gt;Redis: srem userId
        end
        Redis--&gt;&gt;UserConsumer: 更新成功

        UserConsumer-&gt;&gt;Kafka: 手动ACK确认
        deactivate UserConsumer

    and 消费者2: interaction-service
        Kafka-&gt;&gt;InterConsumer: 推送LikeEvent消息
        activate InterConsumer

        InterConsumer-&gt;&gt;DB: 查询user_likes表&lt;br/&gt;(userId, episodeId)
        DB--&gt;&gt;InterConsumer: 返回查询结果

        alt 记录已存在
            alt action = &quot;like&quot;
                InterConsumer-&gt;&gt;DB: UPDATE status = 1
            else action = &quot;unlike&quot;
                InterConsumer-&gt;&gt;DB: UPDATE status = 0
            end
        else 记录不存在
            InterConsumer-&gt;&gt;DB: INSERT 新记录
        end
        DB--&gt;&gt;InterConsumer: 更新成功

        InterConsumer-&gt;&gt;Redis: 更新缓存中的点赞数
        Redis--&gt;&gt;InterConsumer: 更新成功

        InterConsumer-&gt;&gt;Kafka: 手动ACK确认
        deactivate InterConsumer
    end

    Note over UserConsumer,InterConsumer: 最终一致性保证&lt;br/&gt;数据库持久化 + Redis缓存同步
</code></pre>

<p><strong>流程说明</strong>:</p>
<ol>
<li><strong>异步响应</strong>: 用户点赞后立即返回成功，不等待消费完成（降低响应时间）</li>
<li><strong>并行消费</strong>: user-service和interaction-service同时消费消息，互不阻塞</li>
<li><strong>最终一致性</strong>: 数据库持久化 + Redis缓存最终同步</li>
<li><strong>幂等性保证</strong>:<ul>
<li>数据库: 通过唯一索引 + UPDATE操作保证幂等</li>
<li>Redis Set: sadd&#x2F;srem操作天然幂等</li>
</ul>
</li>
</ol>
<hr>
<h2 id="五、服务间交互关系"><a href="#五、服务间交互关系" class="headerlink" title="五、服务间交互关系"></a>五、服务间交互关系</h2><h3 id="5-1-服务依赖关系图"><a href="#5-1-服务依赖关系图" class="headerlink" title="5.1 服务依赖关系图"></a>5.1 服务依赖关系图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sql">┌──────────────────────────────────────────────────────────────────┐<br>│                         <span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service                             │<br>│                      (BFF聚合层<span class="hljs-operator">/</span>API网关)                          │<br>└───────────┬─────────────────────────┬──────────────────────────┘<br>            │                         │<br>            │ Feign                   │ Feign<br>            ▼                         ▼<br>┌────────────────────────┐   ┌────────────────────────┐<br>│   content<span class="hljs-operator">-</span>service      │   │  interaction<span class="hljs-operator">-</span>service   │<br>│                        │   │                        │<br>│  ┌──────────────────┐ │   │  ┌──────────────────┐  │<br>│  │ Feign            │ │   │  │ Kafka Consumer   │  │<br>│  │   ↓              │ │   │  │   ↓              │  │<br>│  │ camunda<span class="hljs-operator">-</span>service  │ │   │  │ <span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service     │  │<br>│  └──────────────────┘ │   │  └──────────────────┘  │<br>└────────────────────────┘   └────────────────────────┘<br>            ↓                         ↑<br>            │ Feign                   │ Kafka<br>            ▼                         │<br>┌────────────────────────┐            │<br>│   camunda<span class="hljs-operator">-</span>service      │            │<br>│                        │            │<br>│  ┌──────────────────┐ │            │<br>│  │ Feign            │ │            │<br>│  │   ↓              │ │            │<br>│  │ content<span class="hljs-operator">-</span>service  │ │            │<br>│  └──────────────────┘ │            │<br>└────────────────────────┘            │<br>                                      │<br>┌─────────────────────────────────────┴───────────────────────────┐<br>│                         Kafka集群                                │<br>│     Topic: <span class="hljs-keyword">like</span><span class="hljs-operator">-</span>event<span class="hljs-operator">-</span>topic (<span class="hljs-number">10</span>分区)                             │<br>│     生产者: <span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service                                         │<br>│     消费者: <span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service <span class="hljs-operator">+</span> interaction<span class="hljs-operator">-</span>service                   │<br>└──────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<h3 id="5-2-Feign调用关系表"><a href="#5-2-Feign调用关系表" class="headerlink" title="5.2 Feign调用关系表"></a>5.2 Feign调用关系表</h3><table>
<thead>
<tr>
<th>调用方</th>
<th>被调用方</th>
<th>接口</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>user-service</td>
<td>content-service</td>
<td>POST &#x2F;home&#x2F;featured&#x2F;infoflow</td>
<td>查询首页精选视频</td>
</tr>
<tr>
<td>user-service</td>
<td>content-service</td>
<td>POST &#x2F;home&#x2F;dramas&#x2F;{dramaId}&#x2F;episodes&#x2F;all</td>
<td>查询短剧剧集列表</td>
</tr>
<tr>
<td>user-service</td>
<td>content-service</td>
<td>POST &#x2F;home&#x2F;dramas&#x2F;{dramaId}</td>
<td>查询短剧详情</td>
</tr>
<tr>
<td>user-service</td>
<td>interaction-service</td>
<td>GET &#x2F;interaction&#x2F;comments</td>
<td>查询评论列表</td>
</tr>
<tr>
<td>content-service</td>
<td>camunda-service</td>
<td>POST &#x2F;workflow&#x2F;process&#x2F;dramaAuth&#x2F;start</td>
<td>启动短剧审核流程</td>
</tr>
<tr>
<td>content-service</td>
<td>camunda-service</td>
<td>GET &#x2F;workflow&#x2F;process&#x2F;variables&#x2F;{processId}</td>
<td>查询流程变量</td>
</tr>
<tr>
<td>content-service</td>
<td>camunda-service</td>
<td>PUT &#x2F;workflow&#x2F;process&#x2F;manual&#x2F;authTask</td>
<td>执行人工审核任务</td>
</tr>
<tr>
<td>camunda-service</td>
<td>content-service</td>
<td>PUT &#x2F;dramas&#x2F;updateDramaAuthStatus</td>
<td>更新短剧审核状态</td>
</tr>
<tr>
<td>camunda-service</td>
<td>content-service</td>
<td>GET &#x2F;tencent&#x2F;vod&#x2F;translate</td>
<td>触发视频转码</td>
</tr>
</tbody></table>
<h3 id="5-3-Kafka主题与消费者关系"><a href="#5-3-Kafka主题与消费者关系" class="headerlink" title="5.3 Kafka主题与消费者关系"></a>5.3 Kafka主题与消费者关系</h3><table>
<thead>
<tr>
<th>Topic</th>
<th>生产者</th>
<th>消费者</th>
<th>消息类型</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>like-event-topic</td>
<td>user-service</td>
<td>user-service + interaction-service</td>
<td>LikeEvent</td>
<td>点赞事件异步处理</td>
</tr>
</tbody></table>
<p><strong>消息分区策略</strong>:</p>
<ul>
<li>Key设计: <code>like-event-&#123;episodeId&#125;-&#123;userId&#125;</code></li>
<li>保证同一用户对同一剧集的操作顺序性</li>
<li>10个分区，均匀分布</li>
</ul>
<p><strong>消费者组</strong>:</p>
<ul>
<li>user-service: 更新Redis缓存中的点赞数和点赞状态</li>
<li>interaction-service: 更新数据库点赞记录</li>
</ul>
<h3 id="5-4-数据流向图"><a href="#5-4-数据流向图" class="headerlink" title="5.4 数据流向图"></a>5.4 数据流向图</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs css">┌─────────────────────────────────────────────────────────────────────┐<br>│ 用户操作 → user-service → <span class="hljs-attribute">content</span>-service → camunda-service         │<br>│             ↓              ↓                  ↓                       │<br>│          Redis缓存      MySQL数据库       Camunda引擎               │<br>│             ↑              ↑                  ↓                       │<br>│             └──────────────┴───────────── <span class="hljs-attribute">content</span>-service           │<br>│                                               ↓                       │<br>│                                          腾讯云VOD转码                │<br>│                                               ↓                       │<br>│                                          MySQL数据库                 │<br>└─────────────────────────────────────────────────────────────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 用户点赞 → user-service → Kafka → interaction-service               │<br>│             ↓                       ↓                                 │<br>│          Redis缓存              MySQL数据库                          │<br>│             ↑                       ↑                                 │<br>│             └───── Kafka ──────────┘                                 │<br>└─────────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="六、数据库设计"><a href="#六、数据库设计" class="headerlink" title="六、数据库设计"></a>六、数据库设计</h2><h3 id="6-1-数据库架构"><a href="#6-1-数据库架构" class="headerlink" title="6.1 数据库架构"></a>6.1 数据库架构</h3><p><strong>数据库实例</strong>: MySQL 8.0+<br><strong>字符集</strong>: UTF8MB4<br><strong>存储引擎</strong>: InnoDB<br><strong>数据库数量</strong>: 4个业务数据库</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kcat_user</span>       (用户服务数据库 - <span class="hljs-number">9</span>张表)<br><span class="hljs-attribute">kcat_content</span>    (内容服务数据库 - <span class="hljs-number">10</span>张表)<br><span class="hljs-attribute">kcat_interaction</span> (互动服务数据库 - <span class="hljs-number">9</span>张表)<br><span class="hljs-attribute">kcat_camunda</span>    (工作流服务数据库 - Camunda引擎表 + <span class="hljs-number">1</span>张业务表)<br></code></pre></td></tr></table></figure>

<h3 id="6-2-核心表设计"><a href="#6-2-核心表设计" class="headerlink" title="6.2 核心表设计"></a>6.2 核心表设计</h3><h4 id="6-2-1-用户服务（kcat-user）"><a href="#6-2-1-用户服务（kcat-user）" class="headerlink" title="6.2.1 用户服务（kcat_user）"></a>6.2.1 用户服务（kcat_user）</h4><p><strong>users（用户表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> users (<br>  user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;手机号&#x27;</span>,<br>  nickname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;昵称&#x27;</span>,<br>  avatar <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;头像URL&#x27;</span>,<br>  gender TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;性别(0未知/1男/2女)&#x27;</span>,<br>  birthday <span class="hljs-type">DATE</span> COMMENT <span class="hljs-string">&#x27;生日&#x27;</span>,<br>  level <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;用户等级&#x27;</span>,<br>  experience <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;经验值&#x27;</span>,<br>  coin_balance <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;金币余额&#x27;</span>,<br>  vip_expire_time DATETIME COMMENT <span class="hljs-string">&#x27;VIP到期时间&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;状态(0禁用/1正常)&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  INDEX idx_phone (phone),<br>  INDEX idx_nickname (nickname),<br>  INDEX idx_level (level)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户基本信息表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>user_auths（用户认证表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> user_auths (<br>  auth_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  auth_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;认证类型(password/sms/wechat/qq/apple)&#x27;</span>,<br>  auth_key <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;认证标识(手机号/openid等)&#x27;</span>,<br>  auth_credential <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;认证凭证(密码hash/access_token)&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  <span class="hljs-keyword">UNIQUE</span> KEY uk_auth_type_key (auth_type, auth_key),<br>  INDEX idx_user_id (user_id)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户认证方式表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>user_follows（用户关注关系表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> user_follows (<br>  follow_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  follower_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;关注者ID&#x27;</span>,<br>  followee_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;被关注者ID&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;状态(0取消/1有效)&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  <span class="hljs-keyword">UNIQUE</span> KEY uk_follower_followee (follower_id, followee_id),<br>  INDEX idx_follower (follower_id),<br>  INDEX idx_followee (followee_id)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户关注关系表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="6-2-2-内容服务（kcat-content）"><a href="#6-2-2-内容服务（kcat-content）" class="headerlink" title="6.2.2 内容服务（kcat_content）"></a>6.2.2 内容服务（kcat_content）</h4><p><strong>dramas（短剧表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> dramas (<br>  drama_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;标题&#x27;</span>,<br>  sub_title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;副标题&#x27;</span>,<br>  cover <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;封面URL&#x27;</span>,<br>  poster <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;海报URL&#x27;</span>,<br>  trailer_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;预告片URL&#x27;</span>,<br>  trailer_infoflow_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;信息流预告片URL&#x27;</span>,<br>  description TEXT COMMENT <span class="hljs-string">&#x27;简介&#x27;</span>,<br>  story_line TEXT COMMENT <span class="hljs-string">&#x27;剧情介绍&#x27;</span>,<br>  director <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;导演&#x27;</span>,<br>  screenwriter <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;编剧&#x27;</span>,<br>  production_company <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;制作公司&#x27;</span>,<br>  release_date <span class="hljs-type">DATE</span> COMMENT <span class="hljs-string">&#x27;发布日期&#x27;</span>,<br>  total_episodes <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;总集数&#x27;</span>,<br>  episode_duration <span class="hljs-type">INT</span> COMMENT <span class="hljs-string">&#x27;单集时长(秒)&#x27;</span>,<br>  total_duration <span class="hljs-type">INT</span> COMMENT <span class="hljs-string">&#x27;总时长(秒)&#x27;</span>,<br>  <span class="hljs-keyword">language</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;zh-CN&#x27;</span> COMMENT <span class="hljs-string">&#x27;语言&#x27;</span>,<br>  region <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">&#x27;地区&#x27;</span>,<br>  <span class="hljs-keyword">year</span> <span class="hljs-type">INT</span> COMMENT <span class="hljs-string">&#x27;年份&#x27;</span>,<br>  quality <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">&#x27;画质&#x27;</span>,<br>  age_rating <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">&#x27;年龄分级&#x27;</span>,<br>  is_finished TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否完结(0连载/1完结)&#x27;</span>,<br>  is_vip TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否VIP(0否/1是)&#x27;</span>,<br>  is_new TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否新剧(0否/1是)&#x27;</span>,<br>  is_hot TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否热播(0否/1是)&#x27;</span>,<br>  is_recommended TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否推荐(0否/1是)&#x27;</span>,<br>  play_count <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;播放次数&#x27;</span>,<br>  like_count <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点赞数&#x27;</span>,<br>  comment_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;评论数&#x27;</span>,<br>  share_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;分享数&#x27;</span>,<br>  collection_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;收藏数&#x27;</span>,<br>  follow_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;追剧数&#x27;</span>,<br>  rating_score <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">3</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;评分&#x27;</span>,<br>  rating_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;评分人数&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;上架状态(0下架/1上架)&#x27;</span>,<br>  audit_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;审核状态(0待审核/1通过/2拒绝)&#x27;</span>,<br>  audit_reason <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;审核拒绝原因&#x27;</span>,<br>  sort_order <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;排序&#x27;</span>,<br>  create_by <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_by <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  INDEX idx_title (title),<br>  INDEX idx_status_audit (status, audit_status),<br>  INDEX idx_create_time (create_time),<br>  INDEX idx_hot (is_hot),<br>  INDEX idx_new (is_new)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;短剧表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>episodes（剧集表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> episodes (<br>  episode_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  drama_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;短剧ID&#x27;</span>,<br>  title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;标题&#x27;</span>,<br>  episode_number <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;集数&#x27;</span>,<br>  cover <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;封面URL&#x27;</span>,<br>  video_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;视频URL&#x27;</span>,<br>  video_url_hd <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;高清视频URL&#x27;</span>,<br>  video_url_sd <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;标清视频URL&#x27;</span>,<br>  video_url_ld <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;低清视频URL&#x27;</span>,<br>  subtitle_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;字幕URL&#x27;</span>,<br>  duration <span class="hljs-type">INT</span> COMMENT <span class="hljs-string">&#x27;时长(秒)&#x27;</span>,<br>  description TEXT COMMENT <span class="hljs-string">&#x27;简介&#x27;</span>,<br>  is_free TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否免费(0付费/1免费)&#x27;</span>,<br>  is_trailer TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否预告片(0否/1是)&#x27;</span>,<br>  coin_price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;金币价格&#x27;</span>,<br>  play_count <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;播放次数&#x27;</span>,<br>  like_count <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点赞数&#x27;</span>,<br>  comment_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;评论数&#x27;</span>,<br>  share_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;分享数&#x27;</span>,<br>  danmaku_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;弹幕数&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;状态(0删除/1正常)&#x27;</span>,<br>  audit_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;审核状态(0待审核/1通过/2拒绝)&#x27;</span>,<br>  audit_reason <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;审核拒绝原因&#x27;</span>,<br>  publish_time DATETIME COMMENT <span class="hljs-string">&#x27;发布时间&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  INDEX idx_drama_id (drama_id),<br>  INDEX idx_episode_number (episode_number),<br>  <span class="hljs-keyword">UNIQUE</span> KEY uk_drama_episode (drama_id, episode_number)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;剧集表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>drama_auth（短剧审核流程表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> drama_auth (<br>  drama_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;短剧ID&#x27;</span>,<br>  process_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;Camunda流程实例ID&#x27;</span>,<br>  step_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">&#x27;当前步骤名称&#x27;</span>,<br>  auth_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;审核状态(-1未通过/0审核中/1通过)&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  <span class="hljs-keyword">PRIMARY KEY</span> (drama_id),<br>  INDEX idx_process_id (process_id),<br>  INDEX idx_auth_status (auth_status)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;短剧审核流程表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="6-2-3-互动服务（kcat-interaction）"><a href="#6-2-3-互动服务（kcat-interaction）" class="headerlink" title="6.2.3 互动服务（kcat_interaction）"></a>6.2.3 互动服务（kcat_interaction）</h4><p><strong>user_likes（用户点赞记录表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> user_likes (<br>  like_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  target_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;目标ID&#x27;</span>,<br>  target_type TINYINT <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;目标类型(1短剧/2剧集/3评论/4弹幕)&#x27;</span>,<br>  target_user_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;目标所属用户ID&#x27;</span>,<br>  drama_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;短剧ID(冗余字段)&#x27;</span>,<br>  episode_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;剧集ID(冗余字段)&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;状态(0取消/1有效)&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  <span class="hljs-keyword">UNIQUE</span> KEY uk_user_target (user_id, target_id, target_type),<br>  INDEX idx_target (target_id, target_type),<br>  INDEX idx_drama (drama_id),<br>  INDEX idx_episode (episode_id)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户点赞记录表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>comments（评论表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> comments (<br>  comment_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  user_nickname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">&#x27;用户昵称(冗余)&#x27;</span>,<br>  user_avatar <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;用户头像(冗余)&#x27;</span>,<br>  drama_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;短剧ID&#x27;</span>,<br>  episode_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;剧集ID&#x27;</span>,<br>  content TEXT <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;评论内容&#x27;</span>,<br>  parent_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;父评论ID&#x27;</span>,<br>  root_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;根评论ID&#x27;</span>,<br>  reply_user_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">&#x27;回复用户ID&#x27;</span>,<br>  reply_user_nickname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">&#x27;回复用户昵称&#x27;</span>,<br>  like_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点赞数&#x27;</span>,<br>  dislike_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点踩数&#x27;</span>,<br>  reply_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;回复数&#x27;</span>,<br>  is_hot TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否热门(0否/1是)&#x27;</span>,<br>  is_top TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;是否置顶(0否/1是)&#x27;</span>,<br>  ip_address <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">&#x27;IP地址&#x27;</span>,<br>  location <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">&#x27;地理位置&#x27;</span>,<br>  device_info <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;设备信息&#x27;</span>,<br>  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;状态(0删除/1正常/2审核中/3已屏蔽)&#x27;</span>,<br>  audit_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;审核状态(0待审核/1通过/2拒绝)&#x27;</span>,<br>  audit_reason <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) COMMENT <span class="hljs-string">&#x27;审核拒绝原因&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  INDEX idx_user_id (user_id),<br>  INDEX idx_drama_id (drama_id),<br>  INDEX idx_episode_id (episode_id),<br>  INDEX idx_parent_id (parent_id),<br>  INDEX idx_root_id (root_id),<br>  INDEX idx_create_time (create_time)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;评论表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>content_statistics（内容统计表）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> content_statistics (<br>  stat_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTO_INCREMENT,<br>  content_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;内容ID&#x27;</span>,<br>  content_type TINYINT <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;内容类型(1短剧/2剧集)&#x27;</span>,<br>  comment_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;评论数&#x27;</span>,<br>  danmaku_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;弹幕数&#x27;</span>,<br>  like_count <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点赞数&#x27;</span>,<br>  dislike_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;点踩数&#x27;</span>,<br>  share_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;分享数&#x27;</span>,<br>  report_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;举报数&#x27;</span>,<br>  hot_score <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;热度分数&#x27;</span>,<br>  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>  <span class="hljs-keyword">UNIQUE</span> KEY uk_content (content_id, content_type)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;内容统计表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="6-3-表关系ER图"><a href="#6-3-表关系ER图" class="headerlink" title="6.3 表关系ER图"></a>6.3 表关系ER图</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">┌──────────────────────────────────────────────────────────────────────┐<br>│ 用户服务（<span class="hljs-type">kcat_user</span>）                                                 │<br>└──────────────────────────────────────────────────────────────────────┘<br>    <span class="hljs-variable">users</span> <span class="hljs-punctuation">(</span>用户基本信息<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_auths</span> <span class="hljs-punctuation">(</span>认证方式<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_follows</span> <span class="hljs-punctuation">(</span>关注关系 <span class="hljs-operator">-</span> <span class="hljs-type">follower_id</span><span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-built_in">N</span><span class="hljs-operator">:</span><span class="hljs-number">1</span> ← <span class="hljs-type">user_follows</span> <span class="hljs-punctuation">(</span>粉丝关系 <span class="hljs-operator">-</span> <span class="hljs-type">followee_id</span><span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_collections</span> <span class="hljs-punctuation">(</span>收藏<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_browse</span><span class="hljs-type">_history</span> <span class="hljs-punctuation">(</span>浏览历史<span class="hljs-punctuation">)</span><br>      └── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_devices</span> <span class="hljs-punctuation">(</span>设备<span class="hljs-punctuation">)</span><br><br>┌──────────────────────────────────────────────────────────────────────┐<br>│ 内容服务（<span class="hljs-type">kcat_content</span>）                                              │<br>└──────────────────────────────────────────────────────────────────────┘<br>    <span class="hljs-variable">dramas</span> <span class="hljs-punctuation">(</span>短剧<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">episodes</span> <span class="hljs-punctuation">(</span>剧集<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-variable">M</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">actors</span> <span class="hljs-punctuation">(</span>演员<span class="hljs-punctuation">)</span> 通过 <span class="hljs-type">drama_actors</span><br>      ├── <span class="hljs-variable">M</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">categories</span> <span class="hljs-punctuation">(</span>分类<span class="hljs-punctuation">)</span> 通过 <span class="hljs-type">drama_categories</span><br>      ├── <span class="hljs-variable">M</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">tags</span> <span class="hljs-punctuation">(</span>标签<span class="hljs-punctuation">)</span> 通过 <span class="hljs-type">drama_tags</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">1</span> → <span class="hljs-type">drama_auth</span> <span class="hljs-punctuation">(</span>审核流程<span class="hljs-punctuation">)</span><br>      └── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">content_audits</span> <span class="hljs-punctuation">(</span>审核记录<span class="hljs-punctuation">)</span><br><br>┌──────────────────────────────────────────────────────────────────────┐<br>│ 互动服务（<span class="hljs-type">kcat_interaction</span>）                                          │<br>└──────────────────────────────────────────────────────────────────────┘<br>    <span class="hljs-variable">users</span> <span class="hljs-punctuation">(</span>外键引用<span class="hljs-type">kcat_user</span><span class="hljs-operator">.</span><span class="hljs-variable">users</span><span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_likes</span> <span class="hljs-punctuation">(</span>点赞<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">comments</span> <span class="hljs-punctuation">(</span>评论<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">danmaku</span> <span class="hljs-punctuation">(</span>弹幕<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">share_records</span> <span class="hljs-punctuation">(</span>分享<span class="hljs-punctuation">)</span><br>      └── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">reports</span> <span class="hljs-punctuation">(</span>举报<span class="hljs-punctuation">)</span><br><br>    <span class="hljs-variable">dramas</span><span class="hljs-operator">/</span><span class="hljs-variable">episodes</span> <span class="hljs-punctuation">(</span>外键引用<span class="hljs-type">kcat_content</span>表<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">user_likes</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">comments</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-variable">danmaku</span><br>      ├── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-built_in">N</span> → <span class="hljs-type">share_records</span><br>      └── <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">1</span> → <span class="hljs-type">content_statistics</span> <span class="hljs-punctuation">(</span>统计<span class="hljs-punctuation">)</span><br><br>┌──────────────────────────────────────────────────────────────────────┐<br>│ 工作流服务（<span class="hljs-type">kcat_camunda</span>）                                            │<br>└──────────────────────────────────────────────────────────────────────┘<br>    <span class="hljs-variable">Camunda</span>引擎表（由<span class="hljs-variable">Camunda</span> <span class="hljs-variable">BPM</span>自动创建管理）<br>      ├── <span class="hljs-type">act_re</span><span class="hljs-type">_</span><span class="hljs-operator">*</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Repository</span> <span class="hljs-operator">-</span> 流程定义<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-type">act_ru</span><span class="hljs-type">_</span><span class="hljs-operator">*</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Runtime</span> <span class="hljs-operator">-</span> 运行时实例<span class="hljs-punctuation">)</span><br>      ├── <span class="hljs-type">act_hi</span><span class="hljs-type">_</span><span class="hljs-operator">*</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">History</span> <span class="hljs-operator">-</span> 历史数据<span class="hljs-punctuation">)</span><br>      └── <span class="hljs-type">act_id</span><span class="hljs-type">_</span><span class="hljs-operator">*</span> <span class="hljs-punctuation">(</span><span class="hljs-built_in">Identity</span> <span class="hljs-operator">-</span> 用户组织<span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>

<h3 id="6-4-索引设计原则"><a href="#6-4-索引设计原则" class="headerlink" title="6.4 索引设计原则"></a>6.4 索引设计原则</h3><ol>
<li><strong>主键索引</strong>: 所有表使用BIGINT自增主键</li>
<li><strong>唯一索引</strong>: 手机号、认证标识等唯一字段</li>
<li><strong>复合索引</strong>: 高频查询条件组合（如status+audit_status）</li>
<li><strong>外键索引</strong>: 关联查询的字段（userId, dramaId, episodeId）</li>
<li><strong>时间索引</strong>: 支持按时间排序和范围查询</li>
<li><strong>状态索引</strong>: 支持状态筛选查询</li>
</ol>
<hr>
<h2 id="七、技术亮点与最佳实践"><a href="#七、技术亮点与最佳实践" class="headerlink" title="七、技术亮点与最佳实践"></a>七、技术亮点与最佳实践</h2><h3 id="7-1-分布式缓存三高防护"><a href="#7-1-分布式缓存三高防护" class="headerlink" title="7.1 分布式缓存三高防护"></a>7.1 分布式缓存三高防护</h3><h4 id="7-1-1-缓存穿透防护（布隆过滤器）"><a href="#7-1-1-缓存穿透防护（布隆过滤器）" class="headerlink" title="7.1.1 缓存穿透防护（布隆过滤器）"></a>7.1.1 缓存穿透防护（布隆过滤器）</h4><p><strong>实现方案</strong>: Redisson BloomFilter</p>
<p><strong>特性</strong>:</p>
<ul>
<li>预计元素: 1000万</li>
<li>误判率: 0.001%</li>
<li>内存占用: 约14.4MB</li>
</ul>
<p><strong>重建机制</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建临时布隆过滤器</span><br>RBloomFilter&lt;Long&gt; tempFilter = redissonClient.getBloomFilter(<span class="hljs-string">&quot;temp_bloom_filter&quot;</span>);<br>tempFilter.tryInit(<span class="hljs-number">10_000_000</span>, <span class="hljs-number">0.001</span>);<br><br><span class="hljs-comment">// 查询所有短剧ID并添加</span><br>List&lt;Long&gt; dramaIds = dramaMapper.selectAllDramaIds();<br><span class="hljs-keyword">for</span> (Long dramaId : dramaIds) &#123;<br>    tempFilter.add(dramaId);<br>&#125;<br><br><span class="hljs-comment">// 毫秒级切换（rename）</span><br>RBloomFilter&lt;Long&gt; oldFilter = redissonClient.getBloomFilter(<span class="hljs-string">&quot;bloom:filter:dramas:id&quot;</span>);<br>oldFilter.rename(<span class="hljs-string">&quot;old_bloom_filter&quot;</span>);<br>tempFilter.rename(<span class="hljs-string">&quot;bloom:filter:dramas:id&quot;</span>);<br>redissonClient.getKeys().delete(<span class="hljs-string">&quot;old_bloom_filter&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><strong>应用场景</strong>: 短剧详情查询、剧集详情查询</p>
<hr>
<h4 id="7-1-2-缓存击穿防护（分布式锁）"><a href="#7-1-2-缓存击穿防护（分布式锁）" class="headerlink" title="7.1.2 缓存击穿防护（分布式锁）"></a>7.1.2 缓存击穿防护（分布式锁）</h4><p><strong>实现方案</strong>: Redisson RLock</p>
<p><strong>加锁流程</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span> + cacheKey;<br><span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);<br><span class="hljs-type">boolean</span> <span class="hljs-variable">lockResult</span> <span class="hljs-operator">=</span> lock.tryLock();<br><br><span class="hljs-keyword">if</span> (lockResult) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 双重检查缓存</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheData</span> <span class="hljs-operator">=</span> redisService.getData(cacheKey);<br>        <span class="hljs-keyword">if</span> (cacheData != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> cacheData;<br>        &#125;<br><br>        <span class="hljs-comment">// 查询数据库</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">dbData</span> <span class="hljs-operator">=</span> queryDatabase();<br><br>        <span class="hljs-comment">// 写入缓存</span><br>        redisService.setData(cacheKey, dbData);<br><br>        <span class="hljs-keyword">return</span> dbData;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        lock.unlock();<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 获取锁失败，等待2秒后重试</span><br>    Thread.sleep(<span class="hljs-number">2000</span>);<br>    <span class="hljs-keyword">return</span> getData(cacheKey);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>优势</strong>: 只有一个线程回源查询，避免数据库瞬时压力</p>
<hr>
<h4 id="7-1-3-缓存雪崩防护（随机过期时间）"><a href="#7-1-3-缓存雪崩防护（随机过期时间）" class="headerlink" title="7.1.3 缓存雪崩防护（随机过期时间）"></a>7.1.3 缓存雪崩防护（随机过期时间）</h4><p><strong>实现方案</strong>: 基础TTL + 随机时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 默认TTL = 7天</span><br><span class="hljs-type">long</span> <span class="hljs-variable">baseTtl</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>;<br><br><span class="hljs-comment">// 随机TTL = 0-99999秒（约0-27小时）</span><br><span class="hljs-type">long</span> <span class="hljs-variable">randomTtl</span> <span class="hljs-operator">=</span> Long.parseLong(RandomUtil.randomNumbers(<span class="hljs-number">5</span>));<br><br><span class="hljs-comment">// 最终TTL</span><br><span class="hljs-type">long</span> <span class="hljs-variable">finalTtl</span> <span class="hljs-operator">=</span> baseTtl + randomTtl;<br><br>stringRedisTemplate.opsForValue().set(cacheKey, jsonStr, finalTtl, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>

<p><strong>效果</strong>: 缓存失效时间分散，避免集体失效</p>
<hr>
<h4 id="7-1-4-缓存一致性（延迟双删）"><a href="#7-1-4-缓存一致性（延迟双删）" class="headerlink" title="7.1.4 缓存一致性（延迟双删）"></a>7.1.4 缓存一致性（延迟双删）</h4><p><strong>实现方案</strong>: 立即删除 + 延迟删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 更新数据库</span><br>updateDatabase(data);<br><br><span class="hljs-comment">// 第一次删除缓存</span><br>stringRedisTemplate.delete(cacheKey);<br><br><span class="hljs-comment">// 延迟10秒再删除（使用ScheduledThreadPoolExecutor）</span><br>scheduledThreadPoolExecutor.schedule(() -&gt; &#123;<br>    stringRedisTemplate.delete(cacheKey);<br>&#125;, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>

<p><strong>适用场景</strong>: 数据更新操作（99%场景有效）</p>
<hr>
<h3 id="7-2-自定义AOP缓存注解"><a href="#7-2-自定义AOP缓存注解" class="headerlink" title="7.2 自定义AOP缓存注解"></a>7.2 自定义AOP缓存注解</h3><p><strong>@CacheData注解</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CacheData &#123;<br>    String <span class="hljs-title function_">cacheKey</span><span class="hljs-params">()</span>;               <span class="hljs-comment">// 缓存Key（支持SpEL格式化）</span><br>    String <span class="hljs-title function_">bloomFilterKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>; <span class="hljs-comment">// 布隆过滤器Key</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>使用示例</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheData(cacheKey = RedisConstants.DRAMA_DETAIL_CACHE_KEY,</span><br><span class="hljs-meta">           bloomFilterKey = RedisConstants.BLOOM_FILTER_DRAMAS_ID)</span><br><span class="hljs-keyword">public</span> HomeDramaInfoDto <span class="hljs-title function_">getDramaDetail</span><span class="hljs-params">(Long dramaId)</span> &#123;<br>    <span class="hljs-comment">// 方法体：远程调用content-service</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>CacheDataAspect切面逻辑</strong>:</p>
<ol>
<li>解析方法参数（dramaId）和返回值类型</li>
<li>拼接缓存Key（支持格式化占位符，如<code>drama:detail:&#123;dramaId&#125;</code>）</li>
<li>查询缓存 → 命中则返回</li>
<li>未命中 → 判断布隆过滤器 → 不存在则返回null</li>
<li>存在 → 尝试获取分布式锁</li>
<li>获取锁成功 → 执行目标方法 → 写入缓存 → 释放锁</li>
<li>获取锁失败 → 等待2秒 → 重新查询缓存</li>
</ol>
<p><strong>优势</strong>: 业务代码无侵入，一个注解搞定完整缓存流程</p>
<hr>
<h3 id="7-3-Kafka事件驱动架构"><a href="#7-3-Kafka事件驱动架构" class="headerlink" title="7.3 Kafka事件驱动架构"></a>7.3 Kafka事件驱动架构</h3><h4 id="7-3-1-生产者拦截器（自动填充公共字段）"><a href="#7-3-1-生产者拦截器（自动填充公共字段）" class="headerlink" title="7.3.1 生产者拦截器（自动填充公共字段）"></a>7.3.1 生产者拦截器（自动填充公共字段）</h4><p><strong>KafkaEventProducerInterceptor</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ProducerRecord&lt;String, Object&gt; <span class="hljs-title function_">onSend</span><span class="hljs-params">(ProducerRecord&lt;String, Object&gt; record)</span> &#123;<br>    <span class="hljs-type">BaseEvent</span> <span class="hljs-variable">baseEvent</span> <span class="hljs-operator">=</span> (BaseEvent) record.value();<br><br>    <span class="hljs-comment">// 自动填充msgId（雪花ID）</span><br>    baseEvent.setMsgId(IdUtil.getSnowflakeNextId());<br><br>    <span class="hljs-comment">// 自动填充userId（从Sa-Token获取）</span><br>    baseEvent.setUserId(StpUtil.getLoginIdAsLong());<br><br>    <span class="hljs-comment">// 自动填充timestamp</span><br>    baseEvent.setTimestamp(System.currentTimeMillis());<br><br>    <span class="hljs-keyword">return</span> record;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>效果</strong>: 业务代码只需构造核心业务字段，公共字段自动填充</p>
<hr>
<h4 id="7-3-2-消息幂等性保证"><a href="#7-3-2-消息幂等性保证" class="headerlink" title="7.3.2 消息幂等性保证"></a>7.3.2 消息幂等性保证</h4><p><strong>方案1</strong>: Redis Set记录已处理消息ID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">doneKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;done:like:msg&quot;</span>;<br><span class="hljs-keyword">if</span> (redisTemplate.opsForSet().isMember(doneKey, msgId)) &#123;<br>    <span class="hljs-comment">// 消息已处理，直接ACK</span><br>    ack.acknowledge();<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// 处理业务逻辑</span><br>processBusiness(event);<br><br><span class="hljs-comment">// 记录消息ID</span><br>redisTemplate.opsForSet().add(doneKey, msgId);<br><br><span class="hljs-comment">// 手动ACK</span><br>ack.acknowledge();<br></code></pre></td></tr></table></figure>

<p><strong>方案2</strong>: 数据库唯一索引 + 幂等更新</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- user_likes表设计</span><br><span class="hljs-keyword">UNIQUE</span> KEY uk_user_target (user_id, target_id, target_type)<br><br><span class="hljs-comment">-- 幂等更新SQL</span><br><span class="hljs-keyword">UPDATE</span> user_likes <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> ? <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> target_id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> target_type <span class="hljs-operator">=</span> ?<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="7-3-3-最终一致性保证"><a href="#7-3-3-最终一致性保证" class="headerlink" title="7.3.3 最终一致性保证"></a>7.3.3 最终一致性保证</h4><p><strong>流程</strong>:</p>
<ol>
<li>用户点击点赞 → 发送Kafka消息 → 立即返回成功</li>
<li>Kafka消费者1（user-service）→ 更新Redis缓存</li>
<li>Kafka消费者2（interaction-service）→ 更新数据库</li>
<li>消息持久化 + 手动ACK → 保证消息不丢失</li>
<li>幂等性处理 → 重复消费结果一致</li>
</ol>
<p><strong>优势</strong>:</p>
<ul>
<li>降低接口响应时间（异步处理）</li>
<li>削峰填谷（高并发缓冲）</li>
<li>最终一致性（数据库与缓存同步）</li>
</ul>
<hr>
<h3 id="7-4-Feign响应统一处理"><a href="#7-4-Feign响应统一处理" class="headerlink" title="7.4 Feign响应统一处理"></a>7.4 Feign响应统一处理</h3><p><strong>FeignResponseDecoder</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">decode</span><span class="hljs-params">(Response response, Type type)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.decode(response, type);<br><br>    <span class="hljs-keyword">if</span> (decode <span class="hljs-keyword">instanceof</span> R&lt;?&gt;) &#123;<br>        R&lt;?&gt; r = (R&lt;?&gt;) decode;<br>        <span class="hljs-keyword">if</span> (r.getCode() != <span class="hljs-number">200</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(r.getMsg(), r.getCode());<br>        &#125;<br>        <span class="hljs-comment">// 自动解包，返回data</span><br>        <span class="hljs-keyword">return</span> r.getData();<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> decode;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>优势</strong>:</p>
<ul>
<li>业务代码无需关注R对象的code判断</li>
<li>自动解包，直接获取data</li>
<li>统一异常处理</li>
</ul>
<p><strong>使用示例</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 调用方代码（无需判断R.code）</span><br><span class="hljs-type">HomeDramaInfoDto</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> contentFeignClient.getDramaDetail(dramaId);<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="7-5-线程池并发查询"><a href="#7-5-线程池并发查询" class="headerlink" title="7.5 线程池并发查询"></a>7.5 线程池并发查询</h3><p><strong>ThreadPoolConfig配置</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">thread-pool:</span><br>  <span class="hljs-attr">core-size:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">max-size:</span> <span class="hljs-number">20</span><br>  <span class="hljs-attr">queue-capacity:</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>

<p><strong>应用场景</strong>: 用户信息查询（5个维度数据并发查询）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Users&gt; baseInfoFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">return</span> usersService.getById(userId);<br>&#125;, threadPoolExecutor);<br><br>CompletableFuture&lt;Long&gt; followCountFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">return</span> userFollowsService.count(Wrappers.&lt;UserFollows&gt;lambdaQuery()<br>        .eq(UserFollows::getFollowerId, userId));<br>&#125;, threadPoolExecutor);<br><br><span class="hljs-comment">// ... (其他3个Future)</span><br><br>CompletableFuture.allOf(baseInfoFuture, followCountFuture, ...).join();<br><br><span class="hljs-comment">// 获取结果</span><br><span class="hljs-type">Users</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> baseInfoFuture.get();<br><span class="hljs-type">Long</span> <span class="hljs-variable">followCount</span> <span class="hljs-operator">=</span> followCountFuture.get();<br></code></pre></td></tr></table></figure>

<p><strong>性能提升</strong>: 5个串行查询（假设每个100ms &#x3D; 500ms）→ 并发查询（约100ms）</p>
<hr>
<h3 id="7-6-Sa-Token轻量级认证"><a href="#7-6-Sa-Token轻量级认证" class="headerlink" title="7.6 Sa-Token轻量级认证"></a>7.6 Sa-Token轻量级认证</h3><p><strong>配置模式</strong>: JWT Simple模式（<code>StpLogicJwtForSimple</code>）</p>
<p><strong>特性</strong>:</p>
<ol>
<li><strong>Token生成</strong>: 登录时携带扩展信息（phone, nickname）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">StpUtil.login(userId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SaLoginModel</span>()<br>    .setExtra(<span class="hljs-string">&quot;phone&quot;</span>, phone)<br>    .setExtra(<span class="hljs-string">&quot;nickname&quot;</span>, nickname));<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Token验证</strong>: <code>@SaCheckLogin</code>注解自动鉴权</li>
<li><strong>用户信息获取</strong>:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> StpUtil.getLoginIdAsLong();<br><span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> StpUtil.getExtra(<span class="hljs-string">&quot;phone&quot;</span>).toString();<br></code></pre></td></tr></table></figure>

<ol start="4">
<li><strong>Redis存储</strong>: Token与用户信息映射关系存储在Redis</li>
</ol>
<p><strong>优势</strong>: 轻量级、易用、集成简单</p>
<hr>
<h3 id="7-7-Camunda工作流引擎"><a href="#7-7-Camunda工作流引擎" class="headerlink" title="7.7 Camunda工作流引擎"></a>7.7 Camunda工作流引擎</h3><p><strong>优势</strong>:</p>
<ol>
<li><strong>可视化建模</strong>: BPMN 2.0标准，支持可视化流程设计</li>
<li><strong>灵活扩展</strong>: JavaDelegate机制，业务逻辑与流程解耦</li>
<li><strong>并行任务</strong>: Parallel Gateway支持并行执行</li>
<li><strong>条件路由</strong>: Exclusive Gateway支持条件分支</li>
<li><strong>人工任务</strong>: User Task支持人工审核</li>
<li><strong>流程监控</strong>: 内置流程实例监控和历史查询</li>
</ol>
<p><strong>应用场景</strong>: 短剧审核流程编排</p>
<p><strong>流程定义</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bpmn:process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;DramaAuthProcess&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;短剧审核流程&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;StartEvent_1&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;AI_Check&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AI内容审核&quot;</span></span><br><span class="hljs-tag">                    <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">&quot;$&#123;aiCheck&#125;&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Manual_Audit&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;人工审核&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Gateway_1&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:parallelGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Parallel_1&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;VOD_Translate&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;腾讯云转码&quot;</span></span><br><span class="hljs-tag">                    <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">&quot;$&#123;tecentVodTranslator&#125;&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;RAG_Data&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;RAG数据入库&quot;</span></span><br><span class="hljs-tag">                    <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">&quot;$&#123;ragDataHandler&#125;&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;EndEvent_1&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:process</span>&gt;</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="八、部署架构"><a href="#八、部署架构" class="headerlink" title="八、部署架构"></a>八、部署架构</h2><h3 id="8-1-开发环境部署"><a href="#8-1-开发环境部署" class="headerlink" title="8.1 开发环境部署"></a>8.1 开发环境部署</h3><p><strong>Docker Compose部署清单</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/mysql:/var/lib/mysql</span><br><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;6379:6379&quot;</span><br><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">bitnami/kafka:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9092:9092&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="hljs-string">zookeeper:2181</span><br><br>  <span class="hljs-attr">zookeeper:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">bitnami/zookeeper:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;2181:2181&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">ALLOW_ANONYMOUS_LOGIN:</span> <span class="hljs-literal">yes</span><br><br>  <span class="hljs-attr">nacos:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nacos/nacos-server:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8848:8848&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MODE:</span> <span class="hljs-string">standalone</span><br><br>  <span class="hljs-attr">minio:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">minio/minio:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9000:9000&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9001:9001&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">server</span> <span class="hljs-string">/data</span> <span class="hljs-string">--console-address</span> <span class="hljs-string">&quot;:9001&quot;</span><br><br>  <span class="hljs-attr">ollama:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">ollama/ollama:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;11434:11434&quot;</span><br><br>  <span class="hljs-attr">xxl-job-admin:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">xuxueli/xxl-job-admin:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>服务启动顺序</strong>:</p>
<ol>
<li>MySQL、Redis、Kafka、Zookeeper、Nacos、MinIO、Ollama、XXL-Job</li>
<li>camunda-service、content-service、interaction-service、user-service</li>
</ol>
<hr>
<h3 id="8-2-生产环境部署"><a href="#8-2-生产环境部署" class="headerlink" title="8.2 生产环境部署"></a>8.2 生产环境部署</h3><p><strong>Kubernetes部署架构</strong>:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs awk">┌─────────────────────────────────────────────────────────────────────┐<br>│ Ingress Controller (Nginx)                                          │<br>│   ├── <span class="hljs-regexp">/api/</span>* → user-service                                         │<br>│   ├── <span class="hljs-regexp">/content/</span>* → content-service                                  │<br>│   ├── <span class="hljs-regexp">/interaction/</span>* → interaction-service                          │<br>│   └── <span class="hljs-regexp">/workflow/</span>* → camunda-service                                 │<br>└─────────────────────────────────────────────────────────────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ Service (ClusterIP)                                                  │<br>│   ├── user-service (<span class="hljs-number">3</span> replicas)                                     │<br>│   ├── content-service (<span class="hljs-number">3</span> replicas)                                  │<br>│   ├── interaction-service (<span class="hljs-number">3</span> replicas)                              │<br>│   └── camunda-service (<span class="hljs-number">2</span> replicas)                                  │<br>└─────────────────────────────────────────────────────────────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ StatefulSet                                                          │<br>│   ├── MySQL (Master-Slave <span class="hljs-number">1</span>主<span class="hljs-number">2</span>从)                                   │<br>│   ├── Redis (Cluster <span class="hljs-number">6</span>节点)                                         │<br>│   ├── Kafka (<span class="hljs-number">3</span> brokers)                                             │<br>│   └── Nacos (Cluster <span class="hljs-number">3</span>节点)                                         │<br>└─────────────────────────────────────────────────────────────────────┘<br><br>┌─────────────────────────────────────────────────────────────────────┐<br>│ 外部服务                                                             │<br>│   ├── 腾讯云VOD                                                      │<br>│   ├── MinIO集群                                                      │<br>│   ├── Ollama GPU节点                                                 │<br>│   └── 阿里云短信                                                     │<br>└─────────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<p><strong>资源配置建议</strong>:</p>
<table>
<thead>
<tr>
<th>服务</th>
<th>CPU</th>
<th>内存</th>
<th>副本数</th>
</tr>
</thead>
<tbody><tr>
<td>user-service</td>
<td>2核</td>
<td>4GB</td>
<td>3</td>
</tr>
<tr>
<td>content-service</td>
<td>2核</td>
<td>4GB</td>
<td>3</td>
</tr>
<tr>
<td>interaction-service</td>
<td>2核</td>
<td>4GB</td>
<td>3</td>
</tr>
<tr>
<td>camunda-service</td>
<td>1核</td>
<td>2GB</td>
<td>2</td>
</tr>
<tr>
<td>MySQL</td>
<td>4核</td>
<td>16GB</td>
<td>3</td>
</tr>
<tr>
<td>Redis</td>
<td>2核</td>
<td>8GB</td>
<td>6</td>
</tr>
<tr>
<td>Kafka</td>
<td>4核</td>
<td>8GB</td>
<td>3</td>
</tr>
<tr>
<td>Nacos</td>
<td>2核</td>
<td>4GB</td>
<td>3</td>
</tr>
</tbody></table>
<hr>
<h3 id="8-3-监控体系"><a href="#8-3-监控体系" class="headerlink" title="8.3 监控体系"></a>8.3 监控体系</h3><p><strong>监控指标</strong>:</p>
<ol>
<li><p><strong>应用监控</strong>:</p>
<ul>
<li>Prometheus + Grafana</li>
<li>JVM指标（堆内存、GC、线程）</li>
<li>接口QPS、响应时间、错误率</li>
</ul>
</li>
<li><p><strong>中间件监控</strong>:</p>
<ul>
<li>MySQL慢查询、连接数</li>
<li>Redis缓存命中率、内存使用率</li>
<li>Kafka消息积压、消费延迟</li>
</ul>
</li>
<li><p><strong>业务监控</strong>:</p>
<ul>
<li>短剧发布量、审核通过率</li>
<li>用户注册量、活跃用户数</li>
<li>点赞数、评论数、播放量</li>
</ul>
</li>
<li><p><strong>日志监控</strong>:</p>
<ul>
<li>ELK (Elasticsearch + Logstash + Kibana)</li>
<li>日志聚合、全文检索、可视化</li>
</ul>
</li>
<li><p><strong>链路追踪</strong>:</p>
<ul>
<li>SkyWalking &#x2F; Zipkin</li>
<li>全链路追踪、调用链分析</li>
</ul>
</li>
</ol>
<hr>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="A-常用命令"><a href="#A-常用命令" class="headerlink" title="A. 常用命令"></a>A. 常用命令</h3><p><strong>启动Docker Compose</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></table></figure>

<p><strong>查看服务状态</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose ps<br></code></pre></td></tr></table></figure>

<p><strong>查看服务日志</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose logs -f user-service<br></code></pre></td></tr></table></figure>

<p><strong>重启服务</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose restart user-service<br></code></pre></td></tr></table></figure>

<p><strong>Maven打包</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p><strong>Kafka创建Topic</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">kafka-topics.sh --create \<br>  --bootstrap-server localhost:9092 \<br>  --topic like-event-topic \<br>  --partitions 10 \<br>  --replication-factor 1<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="B-配置文件模板"><a href="#B-配置文件模板" class="headerlink" title="B. 配置文件模板"></a>B. 配置文件模板</h3><p><strong>application.yml（Nacos配置）</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># application-common.yml（公共配置）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-string">3000ms</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">-1ms</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-string">kafka:9092</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.springframework.kafka.support.serializer.JsonSerializer</span><br>    <span class="hljs-attr">consumer:</span><br>      <span class="hljs-attr">group-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br>      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br>      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.springframework.kafka.support.serializer.JsonDeserializer</span><br>      <span class="hljs-attr">auto-offset-reset:</span> <span class="hljs-string">earliest</span><br>      <span class="hljs-attr">enable-auto-commit:</span> <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># datasource.yml（数据源配置）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://mysql:3306/$&#123;db.name&#125;?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/**/*Mapper.xml</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.qwf.*.domain</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.slf4j.Slf4jImpl</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="C-常见问题FAQ"><a href="#C-常见问题FAQ" class="headerlink" title="C. 常见问题FAQ"></a>C. 常见问题FAQ</h3><p><strong>Q1: Kafka消息积压怎么办？</strong><br>A: 增加消费者实例数、优化消费逻辑、增加分区数</p>
<p><strong>Q2: Redis内存不足怎么办？</strong><br>A: 设置合理的过期时间、使用LRU淘汰策略、扩容Redis节点</p>
<p><strong>Q3: Camunda流程实例查询慢？</strong><br>A: 定期归档历史数据、优化数据库索引、使用缓存</p>
<p><strong>Q4: 视频转码失败怎么办？</strong><br>A: 检查腾讯云VOD配置、查看转码模板ID、增加重试机制</p>
<p><strong>Q5: 布隆过滤器误判怎么办？</strong><br>A: 降低误判率（增大内存）、配合缓存空对象使用</p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>本文档详细描述了Kcat短剧平台的完整技术架构和业务流程，涵盖了4个核心微服务（user-service、content-service、interaction-service、camunda-service）的技术实现、服务交互、数据模型、部署架构等全方位内容。</p>
<p><strong>核心技术亮点</strong>:</p>
<ol>
<li>微服务架构（Spring Cloud + Nacos）</li>
<li>工作流引擎（Camunda BPM）</li>
<li>事件驱动架构（Kafka）</li>
<li>分布式缓存三高防护（布隆过滤器 + 分布式锁 + 随机过期）</li>
<li>AI能力集成（Ollama + DeepSeek）</li>
<li>视频云处理（腾讯云VOD）</li>
</ol>
<p><strong>业务场景</strong>:</p>
<ul>
<li>短剧内容管理与发布</li>
<li>AI自动审核 + 人工审核</li>
<li>视频转码与多清晰度支持</li>
<li>用户互动（点赞、评论、弹幕）</li>
<li>首页精选视频推荐</li>
</ul>
<p>该系统架构设计合理、分层清晰、扩展性强，是一个完整的企业级短视频内容分发平台解决方案。</p>
<hr>
<p><strong>文档版本</strong>: v1.0<br><strong>生成日期</strong>: 2025-09-30<br><strong>作者</strong>: Claude Code<br><strong>文档字数</strong>: 约35000字</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/kcat/" class="print-no-link">#kcat</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>100快猫短剧</div>
      <div>http://example.com/2025/11/23/101架构和流程文档/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>無鎏雲</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年11月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/23/Untitled%201/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/22/100%E5%BF%AB%E7%8C%AB%E7%9F%AD%E5%89%A7/" title="100快猫短剧">
                        <span class="hidden-mobile">100快猫短剧</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
